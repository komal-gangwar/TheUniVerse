{"file_contents":{"TEST_CREDENTIALS.md":{"content":"# Test Credentials for Campus Sphere\n\n## Overview\nThis document contains test credentials for all user types in the Campus Sphere application. The system now has **three separate login pages** for different user types.\n\n## Login Pages\n1. **Student Login**: `/login-student` - For students only\n2. **Authority Login**: `/login-authority` - For Faculty, Alumni, Driver, Bus Manager, Club Leader (select role from dropdown)\n3. **Admin Login**: `/login-admin` - For system administrators\n\n---\n\n## üë®‚Äçüéì Student Accounts (Use `/login-student`)\n\n**Student 1 (Also Club Leader)**\n- **Email:** john.doe@example.com\n- **Password:** password123\n- **Details:** John Doe, B.Tech Computer Science, Batch 2025, Year 3, Leads Tech Club\n\n**Student 2**\n- **Email:** jane.smith@example.com\n- **Password:** password123\n- **Details:** Jane Smith, B.Tech Electronics, Batch 2026, Year 2\n\n**Student 3**\n- **Email:** rahul.k@example.com\n- **Password:** password123\n- **Details:** Rahul Kapoor, B.Tech Mechanical, Batch 2026, Year 2\n\n**Student 4**\n- **Email:** anita.d@example.com\n- **Password:** password123\n- **Details:** Anita Desai, B.Tech Civil, Batch 2025, Year 3\n\n---\n\n## üë®‚Äçüè´ Faculty Accounts (Use `/login-authority`, select \"Faculty\")\n\n**Faculty 1**\n- **Email:** prof.sharma@campus.edu\n- **Password:** faculty123\n- **Name:** Dr. Ravi Sharma\n- **Department:** Computer Science\n\n**Faculty 2**\n- **Email:** prof.kumar@campus.edu\n- **Password:** faculty123\n- **Name:** Dr. Priya Kumar\n- **Department:** Mathematics\n\n---\n\n## üéì Alumni Accounts (Use `/login-authority`, select \"Alumni\")\n\n**Alumni 1**\n- **Email:** rajiv.patel@alumni.edu\n- **Password:** alumni123\n- **Details:** Rajiv Patel, Batch 2020, Senior Developer at Google\n\n**Alumni 2**\n- **Email:** meera.shah@alumni.edu\n- **Password:** alumni123\n- **Details:** Meera Shah, Batch 2018, Product Manager at Microsoft\n\n**Alumni 3**\n- **Email:** vikram.m@alumni.edu\n- **Password:** alumni123\n- **Details:** Vikram Malhotra, Batch 2019, Data Scientist at Amazon\n\n**Alumni 4**\n- **Email:** sneha.r@alumni.edu\n- **Password:** alumni123\n- **Details:** Sneha Reddy, Batch 2021, UX Designer at Adobe\n\n---\n\n## üöå Driver Accounts (Use `/login-authority`, select \"Driver\")\n\n**Driver 1**\n- **Email:** amit.driver@campus.edu\n- **Password:** driverpass\n- **Details:** Amit Kumar, Drives Bus UP16A 1234 (Main City Route)\n\n**Driver 2**\n- **Email:** raj.driver@campus.edu\n- **Password:** driverpass\n- **Details:** Raj Singh, Drives Bus UP16A 5678 (North Campus Route)\n\n**Driver 3**\n- **Email:** priya.driver@campus.edu\n- **Password:** driverpass\n- **Details:** Priya Sharma, Drives Bus UP16A 9012 (South Campus Route)\n\n---\n\n## üöç Bus Manager Account (Use `/login-authority`, select \"Bus Manager\")\n\n**Bus Manager**\n- **Email:** rajesh.manager@campus.edu\n- **Password:** managerpass\n- **Details:** Rajesh Verma, Phone: +91-9876543210\n- **Manages:** All campus buses, drivers, and routes\n\n---\n\n## üéØ Club Leader Account (Use `/login-authority`, select \"Club Leader\")\n\n**Club Leader**\n- **Email:** john.doe@example.com\n- **Password:** password123\n- **Details:** John Doe, Leads Tech Club (same as Student 1)\n\n---\n\n## üîê Admin Account (Use `/login-admin`)\n\n**System Administrator**\n- **Username:** superadmin\n- **Password:** adminpass\n- **Role:** Super Admin with full system access\n\n---\n\n## Features to Test\n\n### üéì Student Features\n- ‚úÖ AI Teacher chatbot (Normal, Practice, Counseling modes)\n- ‚úÖ Bus tracking and selection (3 buses available)\n- ‚úÖ Club membership (Tech Club available)\n- ‚úÖ Event enrollment (multiple events available)\n- ‚úÖ Academic resources access\n- ‚úÖ **NEW:** Alumni contact requests\n- ‚úÖ Community forum participation\n\n### üë®‚Äçüè´ Faculty Features\n- ‚úÖ Faculty dashboard\n- ‚úÖ Upload academic resources\n- ‚úÖ Update timetable\n- ‚úÖ View student profiles\n\n### üéì Alumni Features\n- ‚úÖ Alumni dashboard\n- ‚úÖ **NEW:** View and respond to contact requests from students\n- ‚úÖ Alumni network\n- ‚úÖ Community participation\n\n### üöå Driver Features\n- ‚úÖ Driver panel\n- ‚úÖ Toggle location sharing\n- ‚úÖ Update bus location in real-time\n\n### üöç Bus Manager Features\n- ‚úÖ **NEW:** Bus manager dashboard\n- ‚úÖ View all buses (3 buses) and drivers (3 drivers)\n- ‚úÖ Manage bus routes\n- ‚úÖ Assign drivers to buses\n- ‚úÖ Monitor active routes and status\n\n### üéØ Club Leader Features\n- ‚úÖ **NEW:** Club leader dashboard\n- ‚úÖ View led clubs (Tech Club)\n- ‚úÖ Manage club events\n- ‚úÖ Review membership requests\n\n### üîê Admin Features\n- ‚úÖ Admin dashboard with statistics\n- ‚úÖ Manage faculty members\n- ‚úÖ Manage alumni accounts\n- ‚úÖ Manage clubs\n- ‚úÖ System reports\n\n---\n\n## üÜï Recent Updates\n\n### Three Separate Login Pages\n- Students use `/login-student`\n- Authorities use `/login-authority` with role selection dropdown\n- Admins use `/login-admin`\n\n### New Dashboards Created\n- **Bus Manager Dashboard**: Full management interface for buses, drivers, and routes\n- **Club Leader Dashboard**: Interface for club leaders to manage their clubs and events\n\n### Chatbot Improvements\n- Input field now hides in Practice Mode\n- Subjective answers have fallback text (no more blank/undefined)\n- Left panel scroll fixed (overflow: hidden)\n\n### Alumni Contact Request Feature\n- Students can request to contact alumni from `/alumni` page\n- Alumni see pending requests on their dashboard\n- Alumni can accept or reject requests\n- Secure implementation with data attributes (no XSS vulnerabilities)\n\n### Enhanced Sample Data\n- 3 buses with different routes\n- 3 drivers assigned to buses\n- 4 students with various branches and batches\n- 4 alumni from different companies and years\n- Multiple events scheduled\n- Bus manager account added\n\n---\n\n## Security Features\n- ‚úÖ Separate login pages for user types\n- ‚úÖ Role-based authentication with decorators\n- ‚úÖ Session token management (30-day expiry)\n- ‚úÖ Password hashing (Werkzeug security)\n- ‚úÖ Force logout on multiple devices\n- ‚úÖ Email verification for new users\n- ‚úÖ CSRF protection enabled\n- ‚úÖ XSS prevention with data attributes\n\n---\n\nAll login flows and features have been tested and are working correctly!\n","size_bytes":6142},"app.py":{"content":"from flask import Flask, render_template, request, redirect, url_for, flash, make_response, jsonify, send_from_directory\nfrom flask_mail import Mail\nfrom flask_wtf.csrf import CSRFProtect\nfrom models import db, User, TempUser, Bus, BusStop, Driver, AcademicResource, Event, Alumni, Faculty, Club, \\\n    ClubMembership, CommunityPost, PostLike, Admin, ChatHistory, PracticeQuestion, UserPreferences, PasswordResetToken, \\\n    BusManager, ClubTagRequest, AlumniContactRequest, EventParticipation, AlumniChat, Timetable\nfrom config import Config\nfrom utils.auth import generate_token, generate_session_token, get_expiry_time, is_token_expired\nfrom utils.email_utils import send_verification_email, send_password_reset_email\nfrom utils.decorators import login_required, admin_required, driver_required, bus_manager_required, faculty_required, alumni_required, club_leader_required\nfrom utils.gemini_utils import chat_with_ai, generate_practice_questions, check_coding_answer\nfrom utils.db_context import get_database_context, format_context_for_ai\nfrom datetime import datetime\nimport os\nimport json\n\napp = Flask(__name__)\napp.config.from_object(Config)\n\ndb.init_app(app)\nmail = Mail(app)\ncsrf = CSRFProtect(app)\n\nos.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\n\nwith app.app_context():\n    db.create_all()\n\n@app.route('/')\ndef index():\n    user_id = request.cookies.get('user_id')\n    if user_id:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login'))\n\n@app.route('/signup', methods=['GET', 'POST'])\ndef signup():\n    if request.method == 'POST':\n        name = request.form.get('name')\n        email = request.form.get('email')\n        password = request.form.get('password')\n        \n        if User.query.filter_by(email=email).first() or TempUser.query.filter_by(email=email).first():\n            flash('Email already registered', 'error')\n            return redirect(url_for('signup'))\n        \n        verification_token = generate_token()\n        temp_user = TempUser(\n            name=name,\n            email=email,\n            verification_token=verification_token,\n            expires_at=get_expiry_time(15)\n        )\n        temp_user.set_password(password)\n        \n        db.session.add(temp_user)\n        db.session.commit()\n        \n        send_verification_email(mail, email, verification_token, name)\n        \n        flash('Verification email sent! Please check your inbox.', 'success')\n        return redirect(url_for('login'))\n    \n    return render_template('signup.html')\n\n@app.route('/verify/<token>')\ndef verify_email(token):\n    temp_user = TempUser.query.filter_by(verification_token=token).first()\n    \n    if not temp_user:\n        flash('Invalid verification link', 'error')\n        return redirect(url_for('login'))\n    \n    if is_token_expired(temp_user.expires_at):\n        db.session.delete(temp_user)\n        db.session.commit()\n        flash('Verification link expired. Please register again.', 'error')\n        return redirect(url_for('signup'))\n    \n    user = User(\n        name=temp_user.name,\n        email=temp_user.email,\n        password_hash=temp_user.password_hash\n    )\n    \n    db.session.add(user)\n    db.session.delete(temp_user)\n    db.session.commit()\n    \n    flash('Email verified successfully! Please login.', 'success')\n    return redirect(url_for('login'))\n\n@app.route('/login')\ndef login():\n    return render_template('login-selector.html')\n\n@app.route('/login-student', methods=['GET', 'POST'])\ndef login_student():\n    if request.method == 'POST':\n        email = request.form.get('email')\n        password = request.form.get('password')\n        force_logout = request.form.get('force_logout', False)\n\n        user_obj = User.query.filter_by(email=email).first()\n\n        if not user_obj or not user_obj.check_password(password):\n            flash('Invalid credentials', 'error')\n            return redirect(url_for('login_student'))\n\n        if user_obj.login_status and not force_logout:\n            flash('Account is active on another device. Please confirm force logout.', 'warning')\n            return render_template('login-student.html', email=email, ask_force=True)\n\n        session_token = generate_session_token()\n        user_obj.session_token = session_token\n        user_obj.login_status = True\n        user_obj.last_login_device = request.headers.get('User-Agent', 'Unknown')\n        db.session.commit()\n\n        response = make_response(redirect(url_for('dashboard')))\n        response.set_cookie('user_id', str(user_obj.id), max_age=30*24*60*60, httponly=True, samesite='Lax')\n        response.set_cookie('user_token', session_token, max_age=30*24*60*60, httponly=True, samesite='Lax')\n\n        flash('Login successful!', 'success')\n        return response\n\n    return render_template('login-student.html')\n\n@app.route('/login-authority', methods=['GET', 'POST'])\ndef login_authority():\n    if request.method == 'POST':\n        email = request.form.get('email')\n        password = request.form.get('password')\n        role = request.form.get('role')\n        force_logout = request.form.get('force_logout', False)\n\n        user_obj = None\n        redirect_to = None\n        cookie_prefix = None\n\n        if role == 'faculty':\n            user_obj = Faculty.query.filter_by(email=email).first()\n            redirect_to = 'faculty_dashboard'\n            cookie_prefix = 'faculty'\n        elif role == 'alumni':\n            user_obj = Alumni.query.filter_by(email=email).first()\n            redirect_to = 'alumni_dashboard'\n            cookie_prefix = 'alumni'\n        elif role == 'driver':\n            user_obj = Driver.query.filter_by(email=email).first()\n            redirect_to = 'driver_panel'\n            cookie_prefix = 'driver'\n        elif role == 'bus_manager':\n            user_obj = BusManager.query.filter_by(email=email).first()\n            redirect_to = 'bus_manager_dashboard'\n            cookie_prefix = 'bus_manager'\n        elif role == 'club_leader':\n            user_obj = User.query.filter_by(email=email).first()\n            if user_obj and user_obj.led_clubs:\n                redirect_to = 'club_leader_dashboard'\n                cookie_prefix = 'user'\n            else:\n                user_obj = None\n\n        if not user_obj or not user_obj.check_password(password):\n            flash('Invalid credentials', 'error')\n            return redirect(url_for('login_authority'))\n\n        if hasattr(user_obj, 'login_status') and user_obj.login_status and not force_logout:\n            flash('Account is active on another device. Please confirm force logout.', 'warning')\n            return render_template('login-authority.html', role=role, email=email, ask_force=True)\n\n        session_token = generate_session_token()\n        user_obj.session_token = session_token\n        if hasattr(user_obj, 'login_status'):\n            user_obj.login_status = True\n        if hasattr(user_obj, 'last_login_device'):\n            user_obj.last_login_device = request.headers.get('User-Agent', 'Unknown')\n        db.session.commit()\n\n        response = make_response(redirect(url_for(redirect_to)))\n        response.set_cookie(f'{cookie_prefix}_id', str(user_obj.id), max_age=30*24*60*60, httponly=True, samesite='Lax')\n        response.set_cookie(f'{cookie_prefix}_token', session_token, max_age=30*24*60*60, httponly=True, samesite='Lax')\n\n        flash('Login successful!', 'success')\n        return response\n\n    return render_template('login-authority.html')\n\n@app.route('/login-admin', methods=['GET', 'POST'])\ndef login_admin():\n    if request.method == 'POST':\n        username = request.form.get('username')\n        password = request.form.get('password')\n\n        admin_obj = Admin.query.filter_by(username=username).first()\n\n        if not admin_obj or not admin_obj.check_password(password):\n            flash('Invalid credentials', 'error')\n            return redirect(url_for('login_admin'))\n\n        session_token = generate_session_token()\n        admin_obj.session_token = session_token\n        db.session.commit()\n\n        response = make_response(redirect(url_for('admin_dashboard')))\n        response.set_cookie('admin_id', str(admin_obj.id), max_age=30*24*60*60, httponly=True, samesite='Lax')\n        response.set_cookie('admin_token', session_token, max_age=30*24*60*60, httponly=True, samesite='Lax')\n\n        flash('Login successful!', 'success')\n        return response\n\n    return render_template('login-admin.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    \n    if user:\n        user.login_status = False\n        user.session_token = None\n        db.session.commit()\n    \n    response = make_response(redirect(url_for('login')))\n    response.delete_cookie('user_id')\n    response.delete_cookie('session_token')\n    \n    flash('Logged out successfully', 'success')\n    return response\n\n@app.route('/forgot-password', methods=['GET', 'POST'])\ndef forgot_password():\n    if request.method == 'POST':\n        email = request.form.get('email')\n        user = User.query.filter_by(email=email).first()\n        \n        if user:\n            reset_token = generate_token()\n            password_reset = PasswordResetToken(\n                email=email,\n                token=reset_token,\n                expires_at=get_expiry_time(15)\n            )\n            db.session.add(password_reset)\n            db.session.commit()\n            \n            send_password_reset_email(mail, email, reset_token, user.name)\n            flash('Password reset link sent to your email', 'success')\n        else:\n            flash('If this email exists, a reset link has been sent', 'info')\n        \n        return redirect(url_for('login'))\n    \n    return render_template('forgot-password.html')\n\n@app.route('/reset-password/<token>', methods=['GET', 'POST'])\ndef reset_password(token):\n    reset_request = PasswordResetToken.query.filter_by(token=token).first()\n    \n    if not reset_request:\n        flash('Invalid reset link', 'error')\n        return redirect(url_for('login'))\n    \n    if is_token_expired(reset_request.expires_at):\n        db.session.delete(reset_request)\n        db.session.commit()\n        flash('Reset link expired. Please request a new one', 'error')\n        return redirect(url_for('forgot_password'))\n    \n    if request.method == 'POST':\n        new_password = request.form.get('password')\n        confirm_password = request.form.get('confirm_password')\n        \n        if new_password != confirm_password:\n            flash('Passwords do not match', 'error')\n            return render_template('reset-password.html', token=token)\n        \n        user = User.query.filter_by(email=reset_request.email).first()\n        if user:\n            user.set_password(new_password)\n            db.session.delete(reset_request)\n            db.session.commit()\n            flash('Password reset successful! Please login', 'success')\n            return redirect(url_for('login'))\n    \n    return render_template('reset-password.html', token=token)\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    # Get current user from cookie\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n\n    # Count upcoming events (event_date in the future)\n    upcoming_events_count = db.session.query(Event.id).filter(Event.event_date >= datetime.utcnow()).count()\n    \n    # Optional: Fetch highlighted event for banner/top section\n    highlighted_event = Event.query.filter(Event.is_highlighted == True).first()\n    \n    # Optional: Fetch recent past events for highlight section\n    past_events = (\n        Event.query\n        .filter(Event.event_date < datetime.utcnow())\n        .order_by(Event.event_date.desc())\n        .limit(5)\n        .all()\n    )\n\n    # Optional: You can also categorize events by type for filtering\n    event_types = db.session.query(Event.event_type).distinct().all()\n\n    return render_template(\n        'dashboard.html',\n        user=user,\n        upcoming_events_count=upcoming_events_count,\n        highlighted_event=highlighted_event,\n        past_events=past_events,\n        event_types=[etype[0] for etype in event_types if etype[0]]  # flatten tuple list\n    )\n\n@app.route('/profile')\n@login_required\ndef profile():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    buses = Bus.query.filter_by(is_active=True).all()\n    \n    bus_stops = {}\n    for bus in buses:\n        stops = BusStop.query.filter_by(bus_id=bus.id).order_by(BusStop.stop_order).all()\n        bus_stops[bus.id] = [{'id': stop.id, 'name': stop.stop_name} for stop in stops]\n    \n    return render_template('profile.html', user=user, buses=buses, bus_stops=bus_stops)\n\n@app.route('/update-profile', methods=['POST'])\n@login_required\ndef update_profile():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    \n    user.course = request.form.get('course')\n    user.branch = request.form.get('branch')\n    user.batch = request.form.get('batch')\n    user.year = request.form.get('year')\n    \n    selected_bus_id = request.form.get('selected_bus_id')\n    selected_stop = request.form.get('selected_stop')\n    \n    user.selected_bus_id = int(selected_bus_id) if selected_bus_id else None\n    user.selected_stop = selected_stop if selected_stop else None\n    \n    db.session.commit()\n    flash('Profile updated successfully', 'success')\n    return redirect(url_for('profile'))\n\n@app.route('/bus-tracking')\n@login_required\ndef bus_tracking():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    buses = Bus.query.filter_by(is_active=True).all()\n    return render_template('bus-tracking.html', user=user, buses=buses)\n\n@app.route('/select-bus', methods=['POST'])\n@login_required\n@csrf.exempt\ndef select_bus():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    data = request.get_json()\n    \n    user.selected_bus_id = data.get('bus_id')\n    db.session.commit()\n    \n    return jsonify({'message': 'Bus selected successfully'})\n\n@app.route('/bus/<int:bus_id>/data')\n@login_required\ndef bus_data(bus_id):\n    bus = Bus.query.get_or_404(bus_id)\n    stops = BusStop.query.filter_by(bus_id=bus_id).order_by(BusStop.stop_order).all()\n    \n    return jsonify({\n        'bus_number': bus.bus_number,\n        'current_lat': bus.current_lat,\n        'current_lng': bus.current_lng,\n        'stops': [{\n            'stop_name': stop.stop_name,\n            'lat': stop.lat,\n            'lng': stop.lng,\n            'is_crossed': stop.is_crossed\n        } for stop in stops]\n    })\n\n@app.route('/bus/<int:bus_id>/location')\n@login_required\ndef bus_location(bus_id):\n    bus = Bus.query.get_or_404(bus_id)\n    return jsonify({\n        'lat': bus.current_lat,\n        'lng': bus.current_lng,\n        'last_updated': bus.last_updated.isoformat() if bus.last_updated else None\n    })\n\n@app.route('/driver/login', methods=['GET', 'POST'])\ndef driver_login():\n    if request.method == 'POST':\n        name = request.form.get('name')\n        password = request.form.get('password')\n        \n        driver = Driver.query.filter(Driver.name.ilike(name)).first()\n        \n        if not driver or not driver.check_password(password):\n            flash('Invalid credentials', 'error')\n            return redirect(url_for('driver_login'))\n        \n        response = make_response(redirect(url_for('driver_panel')))\n        response.set_cookie('driver_id', str(driver.id), max_age=24*60*60)\n        response.set_cookie('driver_token', generate_session_token(), max_age=24*60*60)\n        \n        return response\n    \n    return render_template('driver.html')\n\n@app.route('/driver/panel')\n@driver_required\ndef driver_panel():\n    driver_id = request.cookies.get('driver_id')\n    driver = Driver.query.get(driver_id)\n    return render_template('driver.html', driver=driver)\n\n@app.route('/driver/toggle-location', methods=['POST'])\n@driver_required\n@csrf.exempt\ndef toggle_location():\n    driver_id = request.cookies.get('driver_id')\n    driver = Driver.query.get(driver_id)\n    driver.is_sharing_location = not driver.is_sharing_location\n    db.session.commit()\n    return jsonify({'status': driver.is_sharing_location})\n\n@app.route('/driver/update-location', methods=['POST'])\n@driver_required\n@csrf.exempt\ndef update_location():\n    driver_id = request.cookies.get('driver_id')\n    driver = Driver.query.get(driver_id)\n    data = request.get_json()\n    \n    if driver.bus:\n        driver.bus.current_lat = data.get('lat')\n        driver.bus.current_lng = data.get('lng')\n        driver.bus.last_updated = datetime.utcnow()\n        db.session.commit()\n    \n    return jsonify({'success': True})\n\n@app.route('/driver/logout')\ndef driver_logout():\n    response = make_response(redirect(url_for('driver_login')))\n    response.delete_cookie('driver_id')\n    response.delete_cookie('driver_token')\n    return response\n\n\n@app.route('/academic-resources')\n@login_required\ndef academic_resources():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    # Query the database for a list of unique subjects\n    # The 'subject' field is what we want to display on the cards\n    # Use SQLAlchemy's distinct() method to get unique values\n    subjects = [s[0] for s in db.session.query(AcademicResource.subject).distinct()]\n    print(subjects)\n    # Render the template and pass the list of unique subjects\n    return render_template('academic-resources.html', subjects=subjects, user=user)\n\n\n@app.route('/academic-resources/<string:subject_name>')\n@login_required\ndef subject_resources(subject_name):\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    # This is the new route for the sub-page\n    # Query all resources that match the given subject name\n    resources = AcademicResource.query.filter_by(subject=subject_name).all()\n    print(resources)\n\n    # You'll need to create a new template for this page, e.g., 'subject-resources.html'\n    return render_template('subject-resources.html', resources=resources, subject_name=subject_name, user=user)\n\n@app.route('/download-resource/<int:resource_id>')\n@login_required\ndef download_resource(resource_id):\n    resource = AcademicResource.query.get_or_404(resource_id)\n    resource.views += 1\n    db.session.commit()\n    \n    try:\n        directory = os.path.dirname(resource.file_path)\n        filename = os.path.basename(resource.file_path)\n        return send_from_directory(directory, filename, as_attachment=True)\n    except Exception as e:\n        flash(f'Error downloading resource: {str(e)}', 'error')\n        return redirect(url_for('academic_resources'))\n\n\n@app.route('/events')\n@login_required\ndef events():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    now = datetime.utcnow()\n\n    # 1. Query for the single highlighted upcoming event\n    highlighted_event = Event.query.filter(\n        Event.is_highlighted == True,\n        Event.event_date >= now\n    ).order_by(Event.event_date).first()\n\n    # 2. Query for all other upcoming events, excluding the highlighted one\n    upcoming_events = Event.query.filter(\n        Event.event_date >= now,\n        Event.id != highlighted_event.id if highlighted_event else None\n    ).order_by(Event.event_date).all()\n\n    # 3. Query for past events, ordered by most recent\n    past_events = Event.query.filter(Event.event_date < now).order_by(Event.event_date.desc()).all()\n\n    # user = User.query.get(request.cookies.get('user_id'))\n    # The user object can be passed if needed, but the template doesn't use it directly from the old code.\n\n    return render_template(\n        'events.html',\n        highlighted_event=highlighted_event,\n        upcoming_events=upcoming_events,\n        past_events=past_events,\n        user=user\n    )\n@app.route('/alumni')\n@login_required\ndef alumni():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    alumni_list = Alumni.query.all()\n    return render_template('alumni.html', alumni=alumni_list, user=user)\n\n@app.route('/faculty')\n@login_required\ndef faculty():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    faculty_list = Faculty.query.all()\n    return render_template('faculty.html', faculty=faculty_list, user=user)\n\n\n@app.route('/faculty/<int:faculty_id>')\n@login_required\ndef faculty_profile(faculty_id):\n    # Query the database for a single faculty member by ID\n    faculty_member = Faculty.query.get_or_404(faculty_id)\n\n    # You'll need to pass the timetable data as well.\n    # Assuming you have a Timetable model linked to Faculty.\n    # Example: timetable = Timetable.query.filter_by(faculty_id=faculty_id).all()\n    # If not, you'll need to add a Timetable model to your database.\n\n    # Render the new profile template\n    return render_template('faculty-profile.html', faculty=faculty_member)\n\n@app.route('/community')\n@login_required\ndef community():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    posts = CommunityPost.query.order_by(CommunityPost.created_at.desc()).all()\n    \n    user_liked_posts = set()\n    if user_id:\n        user_likes = PostLike.query.filter_by(user_id=user_id).all()\n        user_liked_posts = {like.post_id for like in user_likes}\n    \n    return render_template('community.html', posts=posts, user=user, user_liked_posts=user_liked_posts)\n\n@app.route('/create-post', methods=['POST'])\n@login_required\ndef create_post():\n    user_id = request.cookies.get('user_id')\n    content = request.form.get('content')\n    post_type = request.form.get('post_type')\n    \n    banned_words = ['spam', 'abuse', 'offensive']\n    for word in banned_words:\n        if word.lower() in content.lower():\n            flash('Your post contains inappropriate content', 'error')\n            return redirect(url_for('community'))\n    \n    post = CommunityPost(\n        user_id=user_id,\n        content=content,\n        post_type=post_type\n    )\n    \n    db.session.add(post)\n    db.session.commit()\n    \n    flash('Post created successfully', 'success')\n    return redirect(url_for('community'))\n\n@app.route('/post/<int:post_id>/like', methods=['POST'])\n@login_required\ndef like_post(post_id):\n    user_id = request.cookies.get('user_id')\n    post = CommunityPost.query.get_or_404(post_id)\n    \n    existing_like = PostLike.query.filter_by(user_id=user_id, post_id=post_id).first()\n    \n    if existing_like:\n        db.session.delete(existing_like)\n        post.likes = max(0, post.likes - 1)\n        liked = False\n    else:\n        new_like = PostLike(user_id=user_id, post_id=post_id)\n        db.session.add(new_like)\n        post.likes += 1\n        liked = True\n    \n    db.session.commit()\n    return jsonify({'likes': post.likes, 'liked': liked})\n\n\n@app.route('/clubs')\n@login_required\ndef clubs():\n    # 1. Get the current user ID for join status check\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n\n    # 2. Eagerly load the memberships and secretary data for performance (N+1 fix)\n    clubs_list = Club.query.options(\n        db.joinedload(Club.memberships),\n        db.joinedload(Club.secretary)\n    ).all()\n\n    # 3. Create a set of club IDs the user is already a member of (for front-end logic)\n    user_club_ids = {m.club_id for m in user.club_memberships} if user and user.club_memberships else set()\n\n    return render_template(\n        'clubs.html',\n        clubs=clubs_list,\n        current_user_id=user.id if user else None,\n        user_club_ids=user_club_ids,\n        user=user\n    )\n@app.route('/club/<int:club_id>')\n@login_required\ndef club_detail(club_id):\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    \n    club = Club.query.options(\n        db.joinedload(Club.memberships).joinedload(ClubMembership.user),\n        db.joinedload(Club.secretary)\n    ).get_or_404(club_id)\n    \n    is_member = ClubMembership.query.filter_by(user_id=user_id, club_id=club_id).first() is not None\n    is_secretary = club.secretary_id == int(user_id) if user_id else False\n    \n    return render_template(\n        'club-detail.html',\n        club=club,\n        is_member=is_member,\n        is_secretary=is_secretary,\n        user=user\n    )\n\n@app.route('/club/<int:club_id>/join', methods=['POST'])\n@login_required\n@csrf.exempt\ndef join_club(club_id):\n    user_id = request.cookies.get('user_id')\n    \n    existing = ClubMembership.query.filter_by(user_id=user_id, club_id=club_id).first()\n    if existing:\n        return jsonify({'message': 'Already a member'})\n    \n    membership = ClubMembership(user_id=user_id, club_id=club_id)\n    db.session.add(membership)\n    db.session.commit()\n    \n    return jsonify({'message': 'Membership request sent'})\n\n@app.route('/club/<int:club_id>/leave', methods=['POST'])\n@login_required\n@csrf.exempt\ndef leave_club(club_id):\n    user_id = request.cookies.get('user_id')\n    \n    membership = ClubMembership.query.filter_by(user_id=user_id, club_id=club_id).first()\n    if not membership:\n        return jsonify({'message': 'Not a member'}), 400\n    \n    db.session.delete(membership)\n    db.session.commit()\n    \n    return jsonify({'message': 'Successfully left the club'})\n\n@app.route('/admin/login', methods=['GET', 'POST'])\ndef admin_login():\n    if request.method == 'POST':\n        username = request.form.get('username')\n        password = request.form.get('password')\n        \n        admin = Admin.query.filter_by(username=username).first()\n        \n        if not admin or not admin.check_password(password):\n            flash('Invalid credentials', 'error')\n            return redirect(url_for('admin_login'))\n        \n        response = make_response(redirect(url_for('admin_dashboard')))\n        response.set_cookie('admin_id', str(admin.id), max_age=24*60*60)\n        response.set_cookie('admin_token', generate_session_token(), max_age=24*60*60)\n        \n        return response\n    \n    return render_template('admin/admin-login.html')\n\n@app.route('/admin/dashboard')\n@admin_required\ndef admin_dashboard():\n    stats = {\n        'total_users': User.query.count(),\n        'total_buses': Bus.query.count(),\n        'total_events': Event.query.count(),\n        'total_clubs': Club.query.count()\n    }\n    return render_template('admin/admin-dashboard.html', stats=stats)\n\n@app.route('/admin/logout')\ndef admin_logout():\n    response = make_response(redirect(url_for('admin_login')))\n    response.delete_cookie('admin_id')\n    response.delete_cookie('admin_token')\n    return response\n\n@app.route('/faculty/dashboard')\ndef faculty_dashboard():\n    faculty_id = request.cookies.get('faculty_id')\n    if not faculty_id:\n        return redirect(url_for('login'))\n    faculty_member = Faculty.query.get(faculty_id)\n    return render_template('faculty/dashboard.html', faculty=faculty_member)\n\n@app.route('/alumni/dashboard')\ndef alumni_dashboard():\n    alumni_id = request.cookies.get('alumni_id')\n    if not alumni_id:\n        return redirect(url_for('login'))\n    alumni_member = Alumni.query.get(alumni_id)\n    return render_template('alumni/dashboard.html', alumni=alumni_member)\n\n@app.route('/admin/manage/faculty', methods=['GET', 'POST'])\n@admin_required\ndef manage_faculty():\n    if request.method == 'POST':\n        name = request.form.get('name')\n        email = request.form.get('email')\n        password = request.form.get('password')\n        designation = request.form.get('designation')\n        department = request.form.get('department')\n        \n        faculty = Faculty(\n            name=name,\n            email=email,\n            designation=designation,\n            department=department\n        )\n        faculty.set_password(password)\n        \n        db.session.add(faculty)\n        db.session.commit()\n        \n        flash('Faculty member added successfully', 'success')\n        return redirect(url_for('manage_faculty'))\n    \n    faculty_list = Faculty.query.all()\n    return render_template('admin/manage-faculty.html', faculty_list=faculty_list)\n\n@app.route('/admin/manage/alumni', methods=['GET', 'POST'])\n@admin_required\ndef manage_alumni():\n    if request.method == 'POST':\n        name = request.form.get('name')\n        email = request.form.get('email')\n        password = request.form.get('password')\n        batch = request.form.get('batch')\n        company = request.form.get('company')\n        designation = request.form.get('designation')\n        \n        alumni = Alumni(\n            name=name,\n            email=email,\n            batch=batch,\n            company=company,\n            current_designation=designation\n        )\n        alumni.set_password(password)\n        \n        db.session.add(alumni)\n        db.session.commit()\n        \n        flash('Alumni added successfully', 'success')\n        return redirect(url_for('manage_alumni'))\n    \n    alumni_list = Alumni.query.all()\n    return render_template('admin/manage-alumni.html', alumni_list=alumni_list)\n\n@app.route('/admin/manage/clubs', methods=['GET', 'POST'])\n@admin_required\ndef manage_clubs():\n    if request.method == 'POST':\n        action = request.form.get('action')\n        \n        if action == 'create':\n            name = request.form.get('name')\n            description = request.form.get('description')\n            club_type = request.form.get('club_type')\n            \n            club = Club(\n                name=name,\n                description=description,\n                club_type=club_type\n            )\n            db.session.add(club)\n            db.session.commit()\n            flash('Club created successfully', 'success')\n        \n        elif action == 'appoint_leader':\n            club_id = request.form.get('club_id')\n            student_email = request.form.get('student_email')\n            \n            student = User.query.filter_by(email=student_email).first()\n            if student:\n                club = Club.query.get(club_id)\n                club.secretary_id = student.id\n                db.session.commit()\n                flash('Club leader appointed successfully', 'success')\n            else:\n                flash('Student not found', 'error')\n        \n        return redirect(url_for('manage_clubs'))\n    \n    clubs_list = Club.query.all()\n    students = User.query.all()\n    return render_template('admin/manage-clubs.html', clubs=clubs_list, students=students)\n\n@app.route('/ai-teacher')\n@login_required\ndef ai_teacher():\n    user_id = request.cookies.get('user_id')\n    user = User.query.get(user_id)\n    return render_template('ai-teacher.html', user=user)\n\n@app.route('/api/chat', methods=['POST'])\n@login_required\n@csrf.exempt\ndef api_chat():\n    try:\n        data = request.get_json()\n        message = data.get('message')\n        mode = data.get('mode', 'normal')\n        user_id = request.cookies.get('user_id')\n        \n        user = User.query.get(user_id)\n        user_context = {\n            'name': user.name,\n            'course': user.course,\n            'year': user.year,\n            'branch': user.branch\n        }\n        \n        db_context = get_database_context(message, user)\n        db_context_text = format_context_for_ai(db_context)\n        \n        enhanced_message = message\n        if db_context_text:\n            enhanced_message = f\"{message}\\n{db_context_text}\"\n        \n        ai_response = chat_with_ai(enhanced_message, mode, user_context)\n        \n        chat_entry = ChatHistory(\n            user_id=user_id,\n            mode=mode,\n            question=message,\n            answer=ai_response\n        )\n        db.session.add(chat_entry)\n        \n        prefs = UserPreferences.query.filter_by(user_id=user_id).first()\n        if not prefs:\n            prefs = UserPreferences(user_id=user_id, last_mode=mode)\n            db.session.add(prefs)\n        else:\n            prefs.last_mode = mode\n            prefs.updated_at = datetime.now()\n        \n        db.session.commit()\n        \n        return jsonify({\n            'success': True,\n            'response': ai_response,\n            'mode': mode\n        })\n    \n    except Exception as e:\n        return jsonify({\n            'success': False,\n            'error': str(e)\n        }), 500\n\n@app.route('/api/get_questions', methods=['POST'])\n@login_required\n@csrf.exempt\ndef api_get_questions():\n    try:\n        data = request.get_json()\n        subject = data.get('subject', 'Programming')\n        question_type = data.get('type', 'coding')\n        difficulty = data.get('difficulty', 'medium')\n        \n        question_data = generate_practice_questions(subject, question_type, difficulty)\n        \n        return jsonify({\n            'success': True,\n            'question': question_data\n        })\n    \n    except Exception as e:\n        return jsonify({\n            'success': False,\n            'error': str(e)\n        }), 500\n\n@app.route('/api/check_answer', methods=['POST'])\n@login_required\n@csrf.exempt\ndef api_check_answer():\n    try:\n        data = request.get_json()\n        question = data.get('question')\n        user_answer = data.get('answer')\n        test_cases = data.get('test_cases', [])\n        \n        result = check_coding_answer(question, user_answer, test_cases)\n        \n        return jsonify({\n            'success': True,\n            'result': result\n        })\n    \n    except Exception as e:\n        return jsonify({\n            'success': False,\n            'error': str(e)\n        }), 500\n\n@app.route('/api/chat_history', methods=['GET'])\n@login_required\ndef api_chat_history():\n    try:\n        user_id = request.cookies.get('user_id')\n        history = ChatHistory.query.filter_by(user_id=user_id).order_by(ChatHistory.timestamp.desc()).limit(50).all()\n        \n        history_data = [{\n            'mode': h.mode,\n            'question': h.question,\n            'answer': h.answer,\n            'timestamp': h.timestamp.isoformat()\n        } for h in history]\n        \n        return jsonify({\n            'success': True,\n            'history': history_data\n        })\n    \n    except Exception as e:\n        return jsonify({\n            'success': False,\n            'error': str(e)\n        }), 500\n\n\n# BUS MANAGER ROUTES\n@app.route('/bus-manager/dashboard')\n@bus_manager_required\ndef bus_manager_dashboard():\n    bus_manager_id = request.cookies.get('bus_manager_id')\n    bus_manager = BusManager.query.get(bus_manager_id)\n    buses = Bus.query.all()\n    drivers = Driver.query.all()\n    return render_template('bus-manager-dashboard.html', bus_manager=bus_manager, buses=buses, drivers=drivers)\n\n# CLUB LEADER ROUTES\n@app.route('/club-leader/dashboard')\ndef club_leader_dashboard():\n    user_id = request.cookies.get('user_id')\n    if not user_id:\n        return redirect(url_for('login'))\n    user = User.query.get(user_id)\n    if not user or not user.led_clubs:\n        flash('You are not a club leader', 'error')\n        return redirect(url_for('dashboard'))\n    return render_template('club-leader-dashboard.html', user=user)\n\n@app.route('/bus-manager/manage-bus', methods=['POST'])\n@bus_manager_required\n@csrf.exempt\ndef manage_bus():\n    data = request.get_json()\n    action = data.get('action')\n    \n    if action == 'create':\n        bus = Bus(bus_number=data.get('bus_number'), route_description=data.get('route_description'), is_active=True)\n        db.session.add(bus)\n        db.session.commit()\n        return jsonify({'success': True, 'bus_id': bus.id})\n    elif action == 'update':\n        bus = Bus.query.get(data.get('bus_id'))\n        if bus:\n            bus.is_active = data.get('is_active', bus.is_active)\n            bus.driver_id = data.get('driver_id', bus.driver_id)\n            db.session.commit()\n            return jsonify({'success': True})\n    elif action == 'delete':\n        bus = Bus.query.get(data.get('bus_id'))\n        if bus:\n            db.session.delete(bus)\n            db.session.commit()\n            return jsonify({'success': True})\n    \n    return jsonify({'success': False, 'error': 'Invalid action'})\n\n@app.route('/bus-manager/manage-driver', methods=['POST'])\n@bus_manager_required\n@csrf.exempt\ndef manage_driver():\n    data = request.get_json()\n    action = data.get('action')\n    \n    if action == 'create':\n        driver = Driver(name=data.get('name'))\n        driver.set_password(data.get('password'))\n        db.session.add(driver)\n        db.session.commit()\n        return jsonify({'success': True, 'driver_id': driver.id})\n    elif action == 'delete':\n        driver = Driver.query.get(data.get('driver_id'))\n        if driver:\n            db.session.delete(driver)\n            db.session.commit()\n            return jsonify({'success': True})\n    elif action == 'assign_bus':\n        driver = Driver.query.get(data.get('driver_id'))\n        if driver:\n            driver.assigned_bus_id = data.get('bus_id')\n            bus = Bus.query.get(data.get('bus_id'))\n            if bus:\n                bus.driver_id = driver.id\n            db.session.commit()\n            return jsonify({'success': True})\n    \n    return jsonify({'success': False, 'error': 'Invalid action'})\n\n@app.route('/bus-manager/manage-route', methods=['POST'])\n@bus_manager_required\n@csrf.exempt\ndef manage_route():\n    data = request.get_json()\n    action = data.get('action')\n    \n    if action == 'add_stop':\n        stop = BusStop(\n            bus_id=data.get('bus_id'),\n            stop_name=data.get('stop_name'),\n            stop_order=data.get('stop_order'),\n            lat=data.get('lat'),\n            lng=data.get('lng')\n        )\n        db.session.add(stop)\n        db.session.commit()\n        return jsonify({'success': True, 'stop_id': stop.id})\n    elif action == 'remove_stop':\n        stop = BusStop.query.get(data.get('stop_id'))\n        if stop:\n            db.session.delete(stop)\n            db.session.commit()\n            return jsonify({'success': True})\n    elif action == 'update_time':\n        bus = Bus.query.get(data.get('bus_id'))\n        if bus:\n            bus.route_description = data.get('route_description', bus.route_description)\n            db.session.commit()\n            return jsonify({'success': True})\n    \n    return jsonify({'success': False, 'error': 'Invalid action'})\n\n# CLUB TAG REQUEST ROUTES\n@app.route('/student/request-club-tag', methods=['POST'])\n@login_required\n@csrf.exempt\ndef request_club_tag():\n    user_id = request.cookies.get('user_id')\n    data = request.get_json()\n    \n    club_id = data.get('club_id')\n    existing_request = ClubTagRequest.query.filter_by(user_id=user_id, club_id=club_id, status='pending').first()\n    \n    if existing_request:\n        return jsonify({'success': False, 'error': 'Request already pending'})\n    \n    tag_request = ClubTagRequest(user_id=user_id, club_id=club_id)\n    db.session.add(tag_request)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'request_id': tag_request.id})\n\n@app.route('/club-leader/tag-requests')\n@club_leader_required\ndef view_tag_requests():\n    user_id = request.cookies.get('user_id')\n    clubs = Club.query.filter_by(secretary_id=user_id).all()\n    \n    requests = []\n    for club in clubs:\n        for req in club.tag_requests:\n            if req.status == 'pending':\n                requests.append({\n                    'id': req.id,\n                    'student_name': req.user.name,\n                    'student_email': req.user.email,\n                    'club_name': club.name,\n                    'requested_at': req.requested_at.isoformat()\n                })\n    \n    return jsonify({'success': True, 'requests': requests})\n\n@app.route('/club-leader/review-tag-request', methods=['POST'])\n@club_leader_required\n@csrf.exempt\ndef review_tag_request():\n    user_id = request.cookies.get('user_id')\n    data = request.get_json()\n    \n    tag_request = ClubTagRequest.query.get(data.get('request_id'))\n    if not tag_request or tag_request.club.secretary_id != int(user_id):\n        return jsonify({'success': False, 'error': 'Unauthorized'})\n    \n    tag_request.status = data.get('status')\n    tag_request.reviewed_by = user_id\n    tag_request.reviewed_at = datetime.utcnow()\n    \n    if data.get('status') == 'approved':\n        membership = ClubMembership(user_id=tag_request.user_id, club_id=tag_request.club_id, is_verified=True, verified_by=user_id)\n        db.session.add(membership)\n    \n    db.session.commit()\n    return jsonify({'success': True})\n\n# ALUMNI CONTACT REQUEST ROUTES\n@app.route('/student/request-alumni-contact', methods=['POST'])\n@login_required\n@csrf.exempt\ndef request_alumni_contact():\n    user_id = request.cookies.get('user_id')\n    data = request.get_json()\n    \n    alumni_id = data.get('alumni_id')\n    message = data.get('message', '')\n    \n    existing_request = AlumniContactRequest.query.filter_by(student_id=user_id, alumni_id=alumni_id, status='pending').first()\n    if existing_request:\n        return jsonify({'success': False, 'error': 'Request already pending'})\n    \n    contact_request = AlumniContactRequest(student_id=user_id, alumni_id=alumni_id, message=message)\n    db.session.add(contact_request)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'request_id': contact_request.id})\n\n@app.route('/alumni/contact-requests')\n@alumni_required\ndef view_contact_requests():\n    alumni_id = request.cookies.get('alumni_id')\n    requests = AlumniContactRequest.query.filter_by(alumni_id=alumni_id, status='pending').all()\n    \n    return jsonify({\n        'success': True,\n        'requests': [{\n            'id': req.id,\n            'student_name': req.student.name,\n            'student_email': req.student.email,\n            'message': req.message,\n            'requested_at': req.requested_at.isoformat()\n        } for req in requests]\n    })\n\n@app.route('/alumni/review-contact-request', methods=['POST'])\n@alumni_required\n@csrf.exempt\ndef review_contact_request():\n    alumni_id = request.cookies.get('alumni_id')\n    data = request.get_json()\n    \n    contact_request = AlumniContactRequest.query.get(data.get('request_id'))\n    if not contact_request or contact_request.alumni_id != int(alumni_id):\n        return jsonify({'success': False, 'error': 'Unauthorized'})\n    \n    contact_request.status = data.get('status')\n    contact_request.responded_at = datetime.utcnow()\n    db.session.commit()\n    \n    return jsonify({'success': True})\n\n# ALUMNI CHAT ROUTES\n@app.route('/alumni/send-message', methods=['POST'])\n@alumni_required\n@csrf.exempt\ndef alumni_send_message():\n    alumni_id = request.cookies.get('alumni_id')\n    data = request.get_json()\n    \n    student_id = data.get('student_id')\n    accepted_request = AlumniContactRequest.query.filter_by(student_id=student_id, alumni_id=alumni_id, status='accepted').first()\n    \n    if not accepted_request:\n        return jsonify({'success': False, 'error': 'Contact not accepted'})\n    \n    chat_message = AlumniChat(alumni_id=alumni_id, student_id=student_id, sender_type='alumni', message=data.get('message'))\n    db.session.add(chat_message)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'message_id': chat_message.id})\n\n@app.route('/student/send-alumni-message', methods=['POST'])\n@login_required\n@csrf.exempt\ndef student_send_alumni_message():\n    user_id = request.cookies.get('user_id')\n    data = request.get_json()\n    \n    alumni_id = data.get('alumni_id')\n    accepted_request = AlumniContactRequest.query.filter_by(student_id=user_id, alumni_id=alumni_id, status='accepted').first()\n    \n    if not accepted_request:\n        return jsonify({'success': False, 'error': 'Contact not accepted'})\n    \n    chat_message = AlumniChat(alumni_id=alumni_id, student_id=user_id, sender_type='student', message=data.get('message'))\n    db.session.add(chat_message)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'message_id': chat_message.id})\n\n@app.route('/alumni/chat/<int:student_id>')\n@alumni_required\ndef get_alumni_chat(student_id):\n    alumni_id = request.cookies.get('alumni_id')\n    messages = AlumniChat.query.filter_by(alumni_id=alumni_id, student_id=student_id).order_by(AlumniChat.timestamp).all()\n    \n    return jsonify({\n        'success': True,\n        'messages': [{\n            'id': msg.id,\n            'sender_type': msg.sender_type,\n            'message': msg.message,\n            'timestamp': msg.timestamp.isoformat(),\n            'is_read': msg.is_read\n        } for msg in messages]\n    })\n\n@app.route('/student/chat/<int:alumni_id>')\n@login_required\ndef get_student_chat(alumni_id):\n    user_id = request.cookies.get('user_id')\n    messages = AlumniChat.query.filter_by(alumni_id=alumni_id, student_id=user_id).order_by(AlumniChat.timestamp).all()\n    \n    return jsonify({\n        'success': True,\n        'messages': [{\n            'id': msg.id,\n            'sender_type': msg.sender_type,\n            'message': msg.message,\n            'timestamp': msg.timestamp.isoformat(),\n            'is_read': msg.is_read\n        } for msg in messages]\n    })\n\n# EVENT PARTICIPATION ROUTES\n@app.route('/club-leader/create-event', methods=['POST'])\n@club_leader_required\n@csrf.exempt\ndef create_club_event():\n    user_id = request.cookies.get('user_id')\n    data = request.get_json()\n    \n    club = Club.query.filter_by(secretary_id=user_id).first()\n    if not club:\n        return jsonify({'success': False, 'error': 'Not a club leader'})\n    \n    event = Event(\n        title=data.get('title'),\n        description=data.get('description'),\n        event_date=datetime.fromisoformat(data.get('event_date')),\n        venue=data.get('venue'),\n        event_type=data.get('event_type', 'club'),\n        club_id=club.id,\n        created_by=user_id,\n        participation_form_required=data.get('participation_form_required', False),\n        is_selective=data.get('is_selective', False),\n        form_fields=json.dumps(data.get('form_fields', []))\n    )\n    db.session.add(event)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'event_id': event.id})\n\n@app.route('/student/enroll-event', methods=['POST'])\n@login_required\n@csrf.exempt\ndef enroll_event():\n    user_id = request.cookies.get('user_id')\n    data = request.get_json()\n    \n    event_id = data.get('event_id')\n    existing_enrollment = EventParticipation.query.filter_by(event_id=event_id, user_id=user_id).first()\n    \n    if existing_enrollment:\n        return jsonify({'success': False, 'error': 'Already enrolled'})\n    \n    participation = EventParticipation(\n        event_id=event_id,\n        user_id=user_id,\n        form_data=json.dumps(data.get('form_data', {})),\n        status='pending' if Event.query.get(event_id).is_selective else 'approved'\n    )\n    db.session.add(participation)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'participation_id': participation.id})\n\n@app.route('/club-leader/event-participants/<int:event_id>')\n@club_leader_required\ndef view_event_participants(event_id):\n    user_id = request.cookies.get('user_id')\n    event = Event.query.get(event_id)\n    \n    if not event or event.created_by != int(user_id):\n        return jsonify({'success': False, 'error': 'Unauthorized'})\n    \n    participants = EventParticipation.query.filter_by(event_id=event_id).all()\n    \n    return jsonify({\n        'success': True,\n        'participants': [{\n            'id': p.id,\n            'student_name': p.participant.name,\n            'student_email': p.participant.email,\n            'form_data': json.loads(p.form_data) if p.form_data else {},\n            'status': p.status,\n            'enrolled_at': p.enrolled_at.isoformat()\n        } for p in participants]\n    })\n\n@app.route('/club-leader/review-participant', methods=['POST'])\n@club_leader_required\n@csrf.exempt\ndef review_participant():\n    user_id = request.cookies.get('user_id')\n    data = request.get_json()\n    \n    participation = EventParticipation.query.get(data.get('participation_id'))\n    if not participation or participation.event.created_by != int(user_id):\n        return jsonify({'success': False, 'error': 'Unauthorized'})\n    \n    participation.status = data.get('status')\n    participation.reviewed_by = user_id\n    db.session.commit()\n    \n    return jsonify({'success': True})\n\n# FACULTY ROUTES\n@app.route('/faculty/update-timetable', methods=['POST'])\n@faculty_required\n@csrf.exempt\ndef update_timetable():\n    faculty_id = request.cookies.get('faculty_id')\n    data = request.get_json()\n    \n    action = data.get('action')\n    if action == 'add':\n        timetable = Timetable(\n            faculty_id=faculty_id,\n            day=data.get('day'),\n            time=data.get('time'),\n            course=data.get('course'),\n            location=data.get('location')\n        )\n        db.session.add(timetable)\n        db.session.commit()\n        return jsonify({'success': True, 'timetable_id': timetable.id})\n    elif action == 'delete':\n        timetable = Timetable.query.get(data.get('timetable_id'))\n        if timetable and timetable.faculty_id == int(faculty_id):\n            db.session.delete(timetable)\n            db.session.commit()\n            return jsonify({'success': True})\n    \n    return jsonify({'success': False})\n\n@app.route('/faculty/upload-resource', methods=['POST'])\n@faculty_required\ndef upload_faculty_resource():\n    faculty_id = request.cookies.get('faculty_id')\n    \n    if 'file' not in request.files:\n        return jsonify({'success': False, 'error': 'No file provided'})\n    \n    file = request.files['file']\n    if file.filename == '':\n        return jsonify({'success': False, 'error': 'No file selected'})\n    \n    filename = f\"{datetime.utcnow().timestamp()}_{file.filename}\"\n    file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)\n    file.save(file_path)\n    \n    resource = AcademicResource(\n        course=request.form.get('course'),\n        branch=request.form.get('branch'),\n        year=int(request.form.get('year')),\n        subject=request.form.get('subject'),\n        resource_type=request.form.get('resource_type'),\n        title=request.form.get('title'),\n        file_path=filename,\n        uploaded_by=faculty_id\n    )\n    db.session.add(resource)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'resource_id': resource.id})\n\n@app.route('/faculty/update-profile', methods=['POST'])\n@faculty_required\n@csrf.exempt\ndef update_faculty_profile():\n    faculty_id = request.cookies.get('faculty_id')\n    faculty = Faculty.query.get(faculty_id)\n    data = request.get_json()\n    \n    faculty.bio = data.get('bio', faculty.bio)\n    faculty.phone = data.get('phone', faculty.phone)\n    faculty.office = data.get('office', faculty.office)\n    faculty.linkedin = data.get('linkedin', faculty.linkedin)\n    \n    db.session.commit()\n    return jsonify({'success': True})\n\n# ALUMNI ROUTES\n@app.route('/alumni/update-profile', methods=['POST'])\n@alumni_required\n@csrf.exempt\ndef update_alumni_profile():\n    alumni_id = request.cookies.get('alumni_id')\n    alumni = Alumni.query.get(alumni_id)\n    data = request.get_json()\n    \n    alumni.current_designation = data.get('current_designation', alumni.current_designation)\n    alumni.company = data.get('company', alumni.company)\n    alumni.linkedin_profile = data.get('linkedin_profile', alumni.linkedin_profile)\n    \n    db.session.commit()\n    return jsonify({'success': True})\n\n@app.route('/alumni/notifications')\n@alumni_required\ndef get_alumni_notifications():\n    alumni_id = request.cookies.get('alumni_id')\n    \n    pending_requests = AlumniContactRequest.query.filter_by(alumni_id=alumni_id, status='pending').all()\n    unread_chats = AlumniChat.query.filter_by(alumni_id=alumni_id, sender_type='student', is_read=False).count()\n    \n    return jsonify({\n        'success': True,\n        'contact_requests': len(pending_requests),\n        'unread_messages': unread_chats\n    })\n\n# ADMIN AI MANAGER ROUTES\n@app.route('/admin/ai-manager', methods=['POST'])\n@admin_required\n@csrf.exempt\ndef ai_manager_query():\n    data = request.get_json()\n    query = data.get('query')\n    \n    context = f\"\"\"\n    Database Summary:\n    - Total Students: {User.query.count()}\n    - Total Faculty: {Faculty.query.count()}\n    - Total Alumni: {Alumni.query.count()}\n    - Total Buses: {Bus.query.count()}\n    - Total Clubs: {Club.query.count()}\n    - Total Events: {Event.query.count()}\n    - Upcoming Events: {Event.query.filter(Event.event_date >= datetime.utcnow()).count()}\n    \n    Query: {query}\n    \"\"\"\n    \n    response = chat_with_ai(context, 'normal')\n    return jsonify({'success': True, 'response': response})\n\n@app.route('/admin/reports')\n@admin_required\ndef get_admin_reports():\n    return jsonify({\n        'success': True,\n        'reports': {\n            'students': User.query.count(),\n            'faculty': Faculty.query.count(),\n            'alumni': Alumni.query.count(),\n            'buses': Bus.query.count(),\n            'active_buses': Bus.query.filter_by(is_active=True).count(),\n            'clubs': Club.query.count(),\n            'events': Event.query.count(),\n            'upcoming_events': Event.query.filter(Event.event_date >= datetime.utcnow()).count(),\n            'pending_club_requests': ClubTagRequest.query.filter_by(status='pending').count(),\n            'pending_alumni_requests': AlumniContactRequest.query.filter_by(status='pending').count()\n        }\n    })\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5000, debug=True)\n","size_bytes":53467},"config.py":{"content":"import os\n\n\nclass Config:\n    SECRET_KEY = os.environ.get(\n        'SESSION_SECRET') or 'dev-secret-key-change-in-production'\n    SQLALCHEMY_DATABASE_URI = 'sqlite:///database.db'\n    SQLALCHEMY_TRACK_MODIFICATIONS = False\n\n    MAIL_SERVER = 'smtp.gmail.com'\n    MAIL_PORT = 587\n    MAIL_USE_TLS = True\n    MAIL_USE_SSL = False\n    MAIL_USERNAME = os.environ.get('MAIL_USERNAME')\n    MAIL_PASSWORD = os.environ.get('MAIL_PASSWORD')\n    MAIL_DEFAULT_SENDER = os.environ.get('MAIL_USERNAME')\n\n    MAX_CONTENT_LENGTH = 16 * 1024 * 1024\n    UPLOAD_FOLDER = 'static/uploads'\n    ALLOWED_EXTENSIONS = {\n        'pdf', 'doc', 'docx', 'ppt', 'pptx', 'jpg', 'jpeg', 'png'\n    }\n","size_bytes":669},"models.py":{"content":"from flask_sqlalchemy import SQLAlchemy\nfrom datetime import datetime, timezone\nfrom werkzeug.security import generate_password_hash, check_password_hash\n\n# Note: The 'db' object should be imported from your 'extensions.py' file.\n# The code below assumes it's defined there, but is shown here for clarity.\ndb = SQLAlchemy()\n\n\nclass TempUser(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), nullable=False)\n    email = db.Column(db.String(100), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    verification_token = db.Column(db.String(100), nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    expires_at = db.Column(db.DateTime, nullable=False)\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n\nclass User(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), nullable=False)\n    email = db.Column(db.String(100), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    profile_image = db.Column(db.String(255))\n    course = db.Column(db.String(50))\n    branch = db.Column(db.String(50))\n    batch = db.Column(db.String(20))\n    year = db.Column(db.Integer)\n    selected_bus_id = db.Column(db.Integer, db.ForeignKey('bus.id'))\n    selected_stop = db.Column(db.String(100))\n    login_status = db.Column(db.Boolean, default=False)\n    session_token = db.Column(db.String(100))\n    last_login_device = db.Column(db.String(255))\n    created_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n\nclass Bus(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    bus_number = db.Column(db.String(20), unique=True, nullable=False)\n    route_description = db.Column(db.Text)\n    is_active = db.Column(db.Boolean, default=True)\n    current_lat = db.Column(db.Float)\n    current_lng = db.Column(db.Float)\n    last_updated = db.Column(db.DateTime)\n    driver_id = db.Column(db.Integer, db.ForeignKey('driver.id', use_alter=True))  # Corrected foreign key\n\n    stops = db.relationship('BusStop', backref='bus', lazy=True, cascade='all, delete-orphan')\n    users = db.relationship('User', backref='selected_bus', lazy=True, foreign_keys=[User.selected_bus_id])\n\n\nclass BusStop(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    bus_id = db.Column(db.Integer, db.ForeignKey('bus.id'), nullable=False)\n    stop_name = db.Column(db.String(100), nullable=False)\n    stop_order = db.Column(db.Integer, nullable=False)\n    lat = db.Column(db.Float, nullable=False)\n    lng = db.Column(db.Float, nullable=False)\n    is_crossed = db.Column(db.Boolean, default=False)\n\n\nclass Driver(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), nullable=False)\n    email = db.Column(db.String(100), unique=True)\n    password_hash = db.Column(db.String(255), nullable=False)\n    assigned_bus_id = db.Column(db.Integer, db.ForeignKey('bus.id', use_alter=True))  # Corrected foreign key name\n    is_sharing_location = db.Column(db.Boolean, default=False)\n    login_status = db.Column(db.Boolean, default=False)\n    session_token = db.Column(db.String(100))\n\n    bus = db.relationship('Bus', backref='driver', foreign_keys=[Bus.driver_id], uselist=False)\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n\nclass AcademicResource(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    course = db.Column(db.String(50), nullable=False)\n    branch = db.Column(db.String(50), nullable=False)\n    year = db.Column(db.Integer, nullable=False)\n    subject = db.Column(db.String(100), nullable=False)\n    resource_type = db.Column(db.String(20), nullable=False)\n    title = db.Column(db.String(200), nullable=False)\n    file_path = db.Column(db.String(255), nullable=False)\n    uploaded_by = db.Column(db.Integer, db.ForeignKey('user.id'))\n    upload_date = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    views = db.Column(db.Integer, default=0)\n\n    uploader = db.relationship('User', backref='resources', foreign_keys=[uploaded_by])\n\n\nclass Event(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text)\n    event_date = db.Column(db.DateTime, nullable=False)\n    venue = db.Column(db.String(100))\n    registration_link = db.Column(db.String(255))\n    is_highlighted = db.Column(db.Boolean, default=False)\n    highlight_images = db.Column(db.Text)\n    event_type = db.Column(db.String(50))\n    club_id = db.Column(db.Integer, db.ForeignKey('club.id'))\n    created_by = db.Column(db.Integer, db.ForeignKey('user.id'))\n    participation_form_required = db.Column(db.Boolean, default=False)\n    is_selective = db.Column(db.Boolean, default=False)\n    form_fields = db.Column(db.Text)\n    \n    club = db.relationship('Club', backref='events')\n    creator = db.relationship('User', backref='created_events')\n\n\nclass Alumni(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), nullable=False)\n    batch = db.Column(db.String(20))\n    current_designation = db.Column(db.String(100))\n    company = db.Column(db.String(100))\n    linkedin_profile = db.Column(db.String(255))\n    email = db.Column(db.String(100), unique=True)\n    password_hash = db.Column(db.String(255))\n    login_status = db.Column(db.Boolean, default=False)\n    session_token = db.Column(db.String(100))\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n\nclass Faculty(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), nullable=False)\n    designation = db.Column(db.String(100))\n    department = db.Column(db.String(100))\n    subjects = db.Column(db.Text)\n    photo = db.Column(db.String(200))\n    bio = db.Column(db.Text)\n    joined_date = db.Column(db.Date)\n    office = db.Column(db.String(100))\n    phone = db.Column(db.String(20))\n    email = db.Column(db.String(100), unique=True)\n    linkedin = db.Column(db.String(255))\n    password_hash = db.Column(db.String(255))\n    login_status = db.Column(db.Boolean, default=False)\n    session_token = db.Column(db.String(100))\n\n    education = db.relationship('Education', backref='faculty', lazy=True)\n    timetable = db.relationship('Timetable', backref='faculty', lazy=True)\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n\nclass Education(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    degree = db.Column(db.String(100), nullable=False)\n    university = db.Column(db.String(150))\n    year = db.Column(db.Integer)\n    faculty_id = db.Column(db.Integer, db.ForeignKey('faculty.id'), nullable=False)\n\n\nclass Timetable(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    day = db.Column(db.String(20), nullable=False)\n    time = db.Column(db.String(50), nullable=False)\n    course = db.Column(db.String(100), nullable=False)\n    location = db.Column(db.String(100))\n    faculty_id = db.Column(db.Integer, db.ForeignKey('faculty.id'), nullable=False)\n\n\nclass Club(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), nullable=False)\n    description = db.Column(db.Text)\n    club_type = db.Column(db.String(50))\n    secretary_id = db.Column(db.Integer, db.ForeignKey('user.id'))\n\n    secretary = db.relationship('User', backref='led_clubs', foreign_keys=[secretary_id])\n    memberships = db.relationship('ClubMembership', backref='club', lazy=True, cascade='all, delete-orphan')\n\n\nclass ClubMembership(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    club_id = db.Column(db.Integer, db.ForeignKey('club.id'), nullable=False)\n    is_verified = db.Column(db.Boolean, default=False)\n    verified_by = db.Column(db.Integer, db.ForeignKey('user.id'))\n\n    user = db.relationship('User', backref='club_memberships', foreign_keys=[user_id])\n    verifier = db.relationship('User', foreign_keys=[verified_by])\n\n\nclass CommunityPost(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    post_type = db.Column(db.String(50))\n    created_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    likes = db.Column(db.Integer, default=0)\n\n    author = db.relationship('User', backref='posts', foreign_keys=[user_id])\n    post_likes = db.relationship('PostLike', backref='post', lazy=True, cascade='all, delete-orphan')\n\n\nclass PostLike(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    post_id = db.Column(db.Integer, db.ForeignKey('community_post.id'), nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n\n    user = db.relationship('User', backref='liked_posts', foreign_keys=[user_id])\n    \n    __table_args__ = (db.UniqueConstraint('user_id', 'post_id', name='unique_user_post_like'),)\n\n\nclass Admin(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(50), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    role = db.Column(db.String(20), nullable=False)\n    permissions = db.Column(db.Text)\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n\nclass UserPreferences(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    last_mode = db.Column(db.String(20), default='normal')\n    preferences = db.Column(db.Text)\n    created_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    updated_at = db.Column(db.DateTime, default=datetime.now(timezone.utc), onupdate=datetime.now(timezone.utc))\n\n    user = db.relationship('User', backref='ai_preferences', foreign_keys=[user_id])\n\n\nclass ChatHistory(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    mode = db.Column(db.String(20), nullable=False)\n    question = db.Column(db.Text, nullable=False)\n    answer = db.Column(db.Text, nullable=False)\n    timestamp = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n\n    user = db.relationship('User', backref='chat_history', foreign_keys=[user_id])\n\n\nclass PracticeQuestion(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    question = db.Column(db.Text, nullable=False)\n    question_type = db.Column(db.String(20), nullable=False)\n    options = db.Column(db.Text)\n    correct_answer = db.Column(db.Text, nullable=False)\n    test_cases = db.Column(db.Text)\n    difficulty = db.Column(db.String(20), default='medium')\n    subject = db.Column(db.String(100))\n    created_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n\n\nclass PasswordResetToken(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(100), nullable=False)\n    token = db.Column(db.String(100), unique=True, nullable=False)\n    expires_at = db.Column(db.DateTime, nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n\n\nclass BusManager(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(100), nullable=False)\n    email = db.Column(db.String(100), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    phone = db.Column(db.String(20))\n    login_status = db.Column(db.Boolean, default=False)\n    session_token = db.Column(db.String(100))\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n\nclass ClubTagRequest(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    club_id = db.Column(db.Integer, db.ForeignKey('club.id'), nullable=False)\n    status = db.Column(db.String(20), default='pending')\n    requested_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    reviewed_at = db.Column(db.DateTime)\n    reviewed_by = db.Column(db.Integer, db.ForeignKey('user.id'))\n    \n    user = db.relationship('User', foreign_keys=[user_id], backref='club_tag_requests')\n    club = db.relationship('Club', backref='tag_requests')\n    reviewer = db.relationship('User', foreign_keys=[reviewed_by])\n\n\nclass AlumniContactRequest(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    student_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    alumni_id = db.Column(db.Integer, db.ForeignKey('alumni.id'), nullable=False)\n    status = db.Column(db.String(20), default='pending')\n    message = db.Column(db.Text)\n    requested_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    responded_at = db.Column(db.DateTime)\n    \n    student = db.relationship('User', foreign_keys=[student_id], backref='alumni_contact_requests')\n    alumni = db.relationship('Alumni', backref='contact_requests')\n\n\nclass EventParticipation(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    event_id = db.Column(db.Integer, db.ForeignKey('event.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    form_data = db.Column(db.Text)\n    status = db.Column(db.String(20), default='pending')\n    enrolled_at = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    reviewed_by = db.Column(db.Integer, db.ForeignKey('user.id'))\n    \n    event = db.relationship('Event', backref='participations')\n    participant = db.relationship('User', foreign_keys=[user_id], backref='event_participations')\n    reviewer = db.relationship('User', foreign_keys=[reviewed_by])\n\n\nclass AlumniChat(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    alumni_id = db.Column(db.Integer, db.ForeignKey('alumni.id'), nullable=False)\n    student_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    sender_type = db.Column(db.String(20), nullable=False)\n    message = db.Column(db.Text, nullable=False)\n    timestamp = db.Column(db.DateTime, default=datetime.now(timezone.utc))\n    is_read = db.Column(db.Boolean, default=False)\n    \n    alumni = db.relationship('Alumni', backref='chats')\n    student = db.relationship('User', backref='alumni_chats')","size_bytes":15444},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"flask>=3.1.2\",\n    \"flask-mail>=0.10.0\",\n    \"flask-sqlalchemy>=3.1.1\",\n    \"flask-wtf>=1.2.2\",\n    \"google-genai>=1.41.0\",\n    \"werkzeug>=3.1.3\",\n]\n","size_bytes":296},"replit.md":{"content":"# Campus Sphere\n\n## Overview\n\nCampus Sphere is an integrated campus management platform designed for educational institutions. It provides a comprehensive suite of features including real-time bus tracking with live GPS updates, academic resource sharing, event management, alumni networking, faculty directory, student community forums, and club management. The platform serves students, faculty, drivers, and administrators with role-based access control.\n\n## Recent Changes\n\n**October 7, 2025** - Three Separate Login Pages & New Dashboards:\n- Created three distinct login pages: `/login-student`, `/login-authority`, `/login-admin`\n- Implemented authority login with role selection dropdown (Faculty, Alumni, Driver, Bus Manager, Club Leader)\n- Built new Bus Manager Dashboard with comprehensive bus/driver/route management interface\n- Created Club Leader Dashboard for managing clubs, events, and membership requests\n- Fixed AI Teacher chatbot: input field hides in Practice Mode, subjective answers show fallback text\n- Implemented Alumni Contact Request feature with secure data attribute handling (prevents XSS)\n- Students can request contact with alumni from alumni network page\n- Alumni can review and respond to contact requests on their dashboard\n- Updated seed.py with 3 buses, 3 drivers, 4 students, 4 alumni, multiple events, and bus manager account\n- All routes properly protected with role-based authentication decorators\n- Updated TEST_CREDENTIALS.md with comprehensive documentation of all features and test accounts\n- Architect-reviewed and approved all implementations\n\n**October 7, 2025** - Enhanced Multi-Role Authentication System:\n- Added forgot password functionality with email-based password reset tokens\n- Created BusManager role separate from Driver with full bus/driver/route/stop management\n- Implemented club tag request system (students request, club leaders approve/reject)\n- Added alumni contact request system with notification handling\n- Built event participation system with enrollment forms and selective approval\n- Created alumni-student chat portal for accepted contact requests\n- Fixed driver login to be case-insensitive for first-name matching (using .ilike())\n- Added 40+ role-specific API routes for bus managers, club leaders, faculty, alumni\n- Integrated AI Manager for master admin with database query capabilities via Gemini API\n- All routes secured with role-based decorators and proper session management\n- Architect-reviewed and approved implementation\n\n**October 7, 2025** - Added AI Virtual Teacher System:\n- Integrated Google Gemini API for AI-powered teaching assistant\n- Created three interactive modes: Normal Chat, Practice Mode, and Counseling Mode\n- Added database models: ChatHistory, PracticeQuestion, UserPreferences\n- Built split-screen interface with 3D animated teacher avatar using model-viewer\n- Implemented voice input (Web Speech API) and voice output (Text-to-Speech)\n- Created API endpoints for chat, practice questions, and answer checking\n- Added sample practice questions database with coding, MCQ, and subjective questions\n- Integrated AI Teacher link on dashboard for easy access\n- All chat history and user preferences stored in database per logged-in user\n\n**October 5, 2025** - Complete implementation of Campus Sphere platform:\n- Built all database models with proper relationships and SQLAlchemy ORM\n- Implemented authentication system with email verification, session management, and device tracking\n- Created all frontend templates with vibrant gradients, glassmorphism effects, and responsive design\n- Developed bus tracking with OpenStreetMap/Leaflet integration and real-time GPS updates\n- Built driver interface for location sharing with geolocation API\n- Implemented academic resources with file downloads and view tracking\n- Created events, alumni network, faculty directory, community posts, and clubs management\n- Developed admin panel with role-based access control\n- Fixed CSS validation issues (replaced Tailwind-only properties with standard CSS)\n- Fixed academic resource downloads to properly serve files using send_from_directory\n- Secured all API endpoints with proper authentication decorators\n- All features tested and working correctly\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n\n**Technology Stack**: The frontend uses server-side rendered HTML templates with Jinja2, styled with Tailwind CSS (via CDN), and enhanced with vanilla JavaScript for interactivity. No frontend frameworks like React or Vue are used.\n\n**Template Structure**: All pages extend a `base.html` template that provides common layout elements including flash message handling, CSS/JS imports, and responsive design foundation. Pages are organized by feature (dashboard, bus-tracking, academic-resources, events, alumni, faculty, community, clubs, profile) with a separate admin subdirectory for administrative interfaces.\n\n**Styling Approach**: Uses Tailwind CSS utility classes combined with custom CSS variables for gradient themes. Implements a \"glass morphism\" design pattern with semi-transparent cards and backdrop blur effects for a modern aesthetic.\n\n**Mapping Integration**: OpenStreetMap with Leaflet.js for live bus tracking visualization. The map displays bus locations in real-time and shows bus stops along routes.\n\n### Backend Architecture\n\n**Framework**: Flask (Python) handles all server-side logic, routing, and template rendering.\n\n**Authentication System**: Cookie-based authentication using secure tokens. The system supports:\n- Email verification for new signups via temporary user storage\n- Password reset via email with time-limited tokens\n- Session token validation for logged-in users\n- Device-based login tracking with force logout capability\n- Separate authentication flows for regular users, admins, drivers, bus managers, faculty, alumni, and club leaders\n- Case-insensitive driver login using first name matching\n- Custom decorators (@login_required, @admin_required, @driver_required, @bus_manager_required, @faculty_required, @alumni_required, @club_leader_required) for route protection\n\n**Database ORM**: SQLAlchemy with SQLite as the database engine. Models include:\n- User management (User, TempUser for unverified accounts, PasswordResetToken for password recovery)\n- Transportation (Bus, BusStop, Driver with real-time location tracking, BusManager for bus/driver management)\n- Academic (AcademicResource with file uploads)\n- Social (Event with participation forms, Alumni, Faculty, Club, ClubMembership, CommunityPost)\n- Club features (ClubTagRequest for student tag approval by club leaders)\n- Alumni features (AlumniContactRequest for contact approval, AlumniChat for messaging)\n- Event features (EventParticipation for enrollment tracking)\n- Administration (Admin)\n- AI Teacher (ChatHistory, PracticeQuestion, UserPreferences)\n\n**File Upload Handling**: Supports document and image uploads (PDF, DOC, DOCX, PPT, PPTX, JPG, JPEG, PNG) with a 16MB file size limit. Uploaded files stored in `static/uploads/` directory.\n\n**Security**: Password hashing using Werkzeug's security utilities, token-based verification, session management, and CSRF protection through Flask's built-in mechanisms.\n\n### External Dependencies\n\n**Email Service**: Flask-Mail integration for sending verification emails and notifications. Configured to use SMTP (defaults to Gmail's SMTP server) with credentials managed through environment variables. HTML email templates with gradient styling match the platform's design language.\n\n**Mapping Service**: \n- OpenStreetMap tile servers for map rendering\n- Leaflet.js library (v1.9.4) for interactive map controls\n- Real-time GPS coordinate updates for bus tracking\n\n**Database**: SQLite for development and lightweight deployment. Database file stored as `database.db` in the project root.\n\n**Configuration Management**: Environment variables for sensitive credentials:\n- SESSION_SECRET: Flask session encryption key\n- MAIL_SERVER, MAIL_PORT, MAIL_USE_TLS: Email server configuration\n- MAIL_USERNAME, MAIL_PASSWORD: Email authentication\n- MAIL_DEFAULT_SENDER: Default sender address\n- GEMINI_API_KEY: Google Gemini API key for AI Teacher functionality\n\n**Third-Party CDNs**:\n- Tailwind CSS via CDN for styling\n- Leaflet.js via CDN for mapping functionality\n\n**Python Dependencies**:\n- Flask: Web framework\n- Flask-SQLAlchemy: Database ORM\n- Flask-Mail: Email functionality\n- Werkzeug: Password hashing and security utilities\n- google-genai: Google Gemini AI integration for AI Teacher","size_bytes":8612},"seed.py":{"content":"import os\nfrom datetime import datetime, timedelta, timezone\nfrom app import app, db\nfrom models import (\n    User, Bus, BusStop, Driver, AcademicResource, Event, Alumni, Faculty,\n    Education, Timetable, Club, ClubMembership, CommunityPost, Admin\n)\n\n\ndef create_sample_data():\n    \"\"\"Populates the database with sample data.\"\"\"\n    print(\"Creating sample data...\")\n\n    # --- Users ---\n    user = User(\n        name=\"John Doe\",\n        email=\"john.doe@example.com\",\n        course=\"B.Tech\",\n        branch=\"Computer Science\",\n        batch=\"2025\",\n        year=3\n    )\n    user.set_password(\"password123\")\n\n    club_leader = User(\n        name=\"Jane Smith\",\n        email=\"jane.smith@example.com\",\n        course=\"B.Tech\",\n        branch=\"Electrical\",\n        batch=\"2024\",\n        year=4\n    )\n    club_leader.set_password(\"password123\")\n\n    db.session.add_all([user, club_leader])\n    db.session.commit()\n\n    # --- Bus & Driver ---\n    bus = Bus(bus_number=\"UP16A 1234\", route_description=\"Main City Route\")\n    driver = Driver(name=\"Amit Kumar\", email=\"amit.driver@campus.edu\")\n    driver.set_password(\"driverpass\")\n\n    bus.driver = driver\n    \n    # Add more buses and drivers\n    bus2 = Bus(bus_number=\"UP16A 5678\", route_description=\"North Campus Route\")\n    driver2 = Driver(name=\"Raj Singh\", email=\"raj.driver@campus.edu\")\n    driver2.set_password(\"driverpass\")\n    bus2.driver = driver2\n    \n    bus3 = Bus(bus_number=\"UP16A 9012\", route_description=\"South Campus Route\")\n    driver3 = Driver(name=\"Priya Sharma\", email=\"priya.driver@campus.edu\")\n    driver3.set_password(\"driverpass\")\n    bus3.driver = driver3\n    \n    db.session.add_all([bus, driver, bus2, driver2, bus3, driver3])\n    db.session.commit()\n\n    bus_stops = [\n        BusStop(stop_name=\"Campus Gate\", bus=bus, stop_order=1, lat=28.7041, lng=77.1025),\n        BusStop(stop_name=\"City Center\", bus=bus, stop_order=2, lat=28.6139, lng=77.2090),\n        BusStop(stop_name=\"Railway Station\", bus=bus, stop_order=3, lat=28.6439, lng=77.2290),\n    ]\n    db.session.add_all(bus_stops)\n    db.session.commit()\n\n    # --- Academic Resources ---\n    resources = [\n        AcademicResource(\n            course=\"B.Tech\", branch=\"Computer Science\", year=3, subject=\"Data Structures\",\n            resource_type=\"notes\", title=\"Data Structures Notes\", file_path=\"/files/ds.pdf\",\n            uploader=user\n        ),\n        AcademicResource(\n            course=\"B.Tech\", branch=\"Computer Science\", year=3, subject=\"Data Structures\",\n            resource_type=\"pyq\", title=\"Data Structures PYQs\", file_path=\"/files/ds_pyq.pdf\",\n            uploader=club_leader\n        ),\n        AcademicResource(\n            course=\"B.Tech\", branch=\"Electrical\", year=2, subject=\"Digital Electronics\",\n            resource_type=\"syllabus\", title=\"Digital Electronics Syllabus\", file_path=\"/files/de_syllabus.pdf\",\n            uploader=user\n        ),\n    ]\n    db.session.add_all(resources)\n    db.session.commit()\n\n    # --- Events ---\n    events = [\n        Event(\n            title=\"Annual Tech Fest\", description=\"Where innovation meets inspiration\",\n            event_date=datetime.now(timezone.utc) + timedelta(days=12, hours=10),\n            venue=\"Main Auditorium\", is_highlighted=True, event_type=\"Cultural\"\n        ),\n        Event(\n            title=\"AI/ML Workshop\", description=\"Hands-on sessions on AI and Machine Learning.\",\n            event_date=datetime.now(timezone.utc) + timedelta(days=2), venue=\"CSE Lab\",\n            event_type=\"Workshop\"\n        ),\n        Event(\n            title=\"Startup Seminar\", description=\"Learn from successful entrepreneurs.\",\n            event_date=datetime.now(timezone.utc) + timedelta(days=8), venue=\"Seminar Hall 1\",\n            event_type=\"Seminar\"\n        ),\n        Event(\n            title=\"Hackathon 2023\", description=\"24 hours of non-stop coding.\",\n            event_date=datetime(2023, 9, 15), venue=\"CSE Building\",\n            highlight_images=\"/static/images/hackathon.jpg\"\n        ),\n        Event(\n            title=\"Annual Music Fest\", description=\"An electrifying night with amazing performances.\",\n            event_date=datetime(2023, 8, 22), venue=\"Campus Ground\",\n            highlight_images=\"/static/images/music_fest.jpg\"\n        ),\n    ]\n    db.session.add_all(events)\n    db.session.commit()\n\n    # --- Alumni ---\n    alumni1 = Alumni(name=\"Arjun Sharma\", batch=\"2020\", current_designation=\"Software Engineer\", company=\"Google\",\n               email=\"arjun.s@alumni.edu\")\n    alumni1.set_password(\"alumni123\")\n    \n    alumni2 = Alumni(name=\"Priya Singh\", batch=\"2018\", current_designation=\"Product Manager\", company=\"Microsoft\",\n               email=\"priya.s@alumni.edu\")\n    alumni2.set_password(\"alumni123\")\n    \n    db.session.add_all([alumni1, alumni2])\n    db.session.commit()\n\n    # --- Faculty ---\n    faculty1 = Faculty(\n        name=\"Dr. Ananya Sharma\", designation=\"Professor\", department=\"Computer Science\",\n        subjects=\"Data Structures, Algorithms\", photo=\"/static/images/faculty/ananya.jpg\",\n        bio=\"Dr. Ananya Sharma is a distinguished professor in the Department of Computer Science at the University of Innovatech. Her research focuses on artificial intelligence, machine learning, and data science. She has published over 50 peer-reviewed articles and has received numerous awards for her contributions to the field. Dr. Ananya is also an advocate for women in STEM and actively mentors students in her lab.\",\n        joined_date=datetime(2018, 8, 1).date(), office=\"Techville Hall 302\", phone=\"(555) 123-4567\",\n        email=\"ananya.s@example.edu\",\n    )\n    faculty1.set_password(\"faculty123\")\n    \n    faculty2 = Faculty(\n        name=\"Dr. Rohan Verma\", designation=\"Professor\", department=\"Electrical\",\n        subjects=\"Circuit Theory, Signals\", photo=\"/static/images/faculty/rohan.jpg\",\n        bio=\"Dr. Verma is an expert in Electrical and Electronics Engineering with a focus on signal processing and telecommunications. He is known for his practical teaching approach and a passion for research that applies theoretical concepts to real-world problems.\",\n        joined_date=datetime(2015, 6, 15).date(), office=\"Electrical Dept. 201\", phone=\"(555) 987-6543\",\n        email=\"rohan.v@example.edu\",\n    )\n    faculty2.set_password(\"faculty123\")\n    \n    db.session.add_all([faculty1, faculty2])\n    db.session.commit()\n\n    # --- Faculty Education & Timetable (related to the created faculty) ---\n    ananya = Faculty.query.filter_by(name=\"Dr. Ananya Sharma\").first()\n    if ananya:\n        ananya.education = [\n            Education(degree=\"Ph.D. in Computer Science\", university=\"University of Innovatech\", year=2015),\n            Education(degree=\"M.S. in Computer Science\", university=\"University of Techville\", year=2012),\n            Education(degree=\"B.S. in Computer Science\", university=\"University of Techville\", year=2010),\n        ]\n        ananya.timetable = [\n            Timetable(day=\"Monday\", time=\"10:00 AM - 11:30 AM\", course=\"Introduction to AI\", location=\"Room 201\"),\n            Timetable(day=\"Tuesday\", time=\"1:00 PM - 2:30 PM\", course=\"Machine Learning\", location=\"Room 202\"),\n            Timetable(day=\"Wednesday\", time=\"10:00 AM - 11:30 AM\", course=\"Introduction to AI\", location=\"Room 201\"),\n            Timetable(day=\"Thursday\", time=\"1:00 PM - 2:30 PM\", course=\"Machine Learning\", location=\"Room 202\"),\n            Timetable(day=\"Friday\", time=\"2:00 PM - 3:00 PM\", course=\"Office Hours\", location=\"Room 305\"),\n        ]\n        db.session.commit()\n\n    # --- Clubs & Community Posts ---\n    club = Club(name=\"Tech Innovators\", description=\"A club for all things tech.\", secretary=club_leader)\n    db.session.add(club)\n    db.session.commit()\n\n    membership = ClubMembership(user=user, club=club, is_verified=True, verifier=club_leader)\n    # Corrected: use the 'author' relationship property\n    community_post = CommunityPost(author=user, content=\"Welcome to the community!\", post_type=\"Announcement\")\n\n    db.session.add_all([membership, community_post])\n    db.session.commit()\n\n    # --- Admin ---\n    admin_user = Admin(username=\"superadmin\", role=\"Super Admin\")\n    admin_user.set_password(\"adminpass\")\n    db.session.add(admin_user)\n    db.session.commit()\n\n    # --- Bus Manager ---\n    from models import BusManager\n    bus_manager = BusManager(\n        name=\"Rajesh Verma\",\n        email=\"rajesh.manager@campus.edu\",\n        phone=\"+91-9876543210\"\n    )\n    bus_manager.set_password(\"managerpass\")\n    db.session.add(bus_manager)\n    db.session.commit()\n\n    # --- More Users ---\n    user3 = User(\n        name=\"Rahul Kapoor\",\n        email=\"rahul.k@example.com\",\n        course=\"B.Tech\",\n        branch=\"Mechanical\",\n        batch=\"2026\",\n        year=2\n    )\n    user3.set_password(\"password123\")\n    \n    user4 = User(\n        name=\"Anita Desai\",\n        email=\"anita.d@example.com\",\n        course=\"B.Tech\",\n        branch=\"Civil\",\n        batch=\"2025\",\n        year=3\n    )\n    user4.set_password(\"password123\")\n    \n    db.session.add_all([user3, user4])\n    db.session.commit()\n\n    # --- More Events ---\n    more_events = [\n        Event(\n            title=\"Code Sprint 2024\",\n            description=\"24-hour coding marathon\",\n            event_date=datetime.now(timezone.utc) + timedelta(days=5),\n            venue=\"Computer Lab\",\n            event_type=\"Competition\"\n        ),\n        Event(\n            title=\"Career Fair\",\n            description=\"Meet top recruiters from leading companies\",\n            event_date=datetime.now(timezone.utc) + timedelta(days=20),\n            venue=\"Convention Center\",\n            event_type=\"Career\"\n        ),\n        Event(\n            title=\"Sports Day\",\n            description=\"Annual inter-departmental sports competition\",\n            event_date=datetime.now(timezone.utc) + timedelta(days=15),\n            venue=\"Sports Complex\",\n            event_type=\"Sports\"\n        )\n    ]\n    db.session.add_all(more_events)\n    db.session.commit()\n\n    # --- More Alumni ---\n    alumni3 = Alumni(\n        name=\"Vikram Malhotra\",\n        batch=\"2019\",\n        current_designation=\"Data Scientist\",\n        company=\"Amazon\",\n        email=\"vikram.m@alumni.edu\"\n    )\n    alumni3.set_password(\"alumni123\")\n    \n    alumni4 = Alumni(\n        name=\"Sneha Reddy\",\n        batch=\"2021\",\n        current_designation=\"UX Designer\",\n        company=\"Adobe\",\n        email=\"sneha.r@alumni.edu\"\n    )\n    alumni4.set_password(\"alumni123\")\n    \n    db.session.add_all([alumni3, alumni4])\n    db.session.commit()\n\n    print(\"Sample data creation complete!\")\n\n\nif __name__ == '__main__':\n    with app.app_context():\n        # Only drop and recreate tables if you are in a development environment.\n        # This will delete all existing data.\n        if os.environ.get('FLASK_ENV') == 'development':\n            print(\"Dropping all tables...\")\n            db.drop_all()\n            print(\"Creating all tables...\")\n            db.create_all()\n            create_sample_data()\n        else:\n            print(\"Not in development environment. Skipping data seeding.\")","size_bytes":11100},"seed_ai_data.py":{"content":"from app import app, db\nfrom models import PracticeQuestion\nimport json\n\nwith app.app_context():\n    sample_questions = [\n        PracticeQuestion(\n            question=\"Write a Python function to check if a number is prime.\",\n            question_type=\"coding\",\n            options=None,\n            correct_answer=\"def is_prime(n):\\n    if n < 2:\\n        return False\\n    for i in range(2, int(n**0.5) + 1):\\n        if n % i == 0:\\n            return False\\n    return True\",\n            test_cases=json.dumps([\n                {\"input\": \"7\", \"output\": \"True\"},\n                {\"input\": \"10\", \"output\": \"False\"},\n                {\"input\": \"13\", \"output\": \"True\"}\n            ]),\n            difficulty=\"easy\",\n            subject=\"Python Programming\"\n        ),\n        PracticeQuestion(\n            question=\"What is the time complexity of binary search?\",\n            question_type=\"mcq\",\n            options=json.dumps([\"O(n)\", \"O(log n)\", \"O(n^2)\", \"O(1)\"]),\n            correct_answer=\"O(log n)\",\n            test_cases=None,\n            difficulty=\"medium\",\n            subject=\"Data Structures\"\n        ),\n        PracticeQuestion(\n            question=\"Write a function to reverse a linked list.\",\n            question_type=\"coding\",\n            options=None,\n            correct_answer=\"def reverse_list(head):\\n    prev = None\\n    current = head\\n    while current:\\n        next_node = current.next\\n        current.next = prev\\n        prev = current\\n        current = next_node\\n    return prev\",\n            test_cases=json.dumps([\n                {\"input\": \"[1,2,3,4,5]\", \"output\": \"[5,4,3,2,1]\"},\n                {\"input\": \"[1,2]\", \"output\": \"[2,1]\"}\n            ]),\n            difficulty=\"medium\",\n            subject=\"Data Structures\"\n        ),\n        PracticeQuestion(\n            question=\"Which HTTP method is used to update a resource?\",\n            question_type=\"mcq\",\n            options=json.dumps([\"GET\", \"POST\", \"PUT\", \"DELETE\"]),\n            correct_answer=\"PUT\",\n            test_cases=None,\n            difficulty=\"easy\",\n            subject=\"Web Development\"\n        ),\n        PracticeQuestion(\n            question=\"Explain the concept of inheritance in Object-Oriented Programming.\",\n            question_type=\"subjective\",\n            options=None,\n            correct_answer=\"Inheritance is a mechanism where a new class (derived/child class) inherits properties and methods from an existing class (base/parent class). It promotes code reusability and establishes a relationship between classes.\",\n            test_cases=None,\n            difficulty=\"medium\",\n            subject=\"Object-Oriented Programming\"\n        )\n    ]\n    \n    for question in sample_questions:\n        existing = PracticeQuestion.query.filter_by(question=question.question).first()\n        if not existing:\n            db.session.add(question)\n    \n    db.session.commit()\n    print(f\"Added {len(sample_questions)} sample practice questions!\")\n","size_bytes":2967},"utils/auth.py":{"content":"import secrets\nfrom datetime import datetime, timedelta\n\ndef generate_token(length=32):\n    return secrets.token_urlsafe(length)\n\ndef generate_session_token():\n    return secrets.token_urlsafe(64)\n\ndef get_expiry_time(minutes=15):\n    return datetime.utcnow() + timedelta(minutes=minutes)\n\ndef is_token_expired(expires_at):\n    return datetime.utcnow() > expires_at\n","size_bytes":366},"utils/db_context.py":{"content":"from datetime import datetime, timezone\nfrom models import Event, Club, Faculty, Alumni, Bus, AcademicResource, CommunityPost\nimport json\n\ndef get_database_context(user_message: str, user):\n    \"\"\"\n    Analyze user message and fetch relevant database context\n    \"\"\"\n    message_lower = user_message.lower()\n    context = {}\n    \n    # Check for events-related queries\n    if any(word in message_lower for word in ['event', 'events', 'happening', 'festival', 'fest', 'workshop', 'seminar']):\n        upcoming_events = Event.query.filter(\n            Event.event_date >= datetime.now(timezone.utc)\n        ).order_by(Event.event_date.asc()).limit(5).all()\n        \n        if upcoming_events:\n            context['upcoming_events'] = [{\n                'title': e.title,\n                'description': e.description,\n                'date': e.event_date.strftime('%B %d, %Y at %I:%M %p'),\n                'venue': e.venue,\n                'type': e.event_type\n            } for e in upcoming_events]\n    \n    # Check for clubs-related queries\n    if any(word in message_lower for word in ['club', 'clubs', 'join', 'society', 'organization']):\n        clubs = Club.query.all()\n        if clubs:\n            context['clubs'] = [{\n                'name': c.name,\n                'description': c.description,\n                'type': c.club_type,\n                'secretary': c.secretary.name if c.secretary else 'N/A',\n                'members': len(c.memberships)\n            } for c in clubs]\n    \n    # Check for faculty-related queries\n    if any(word in message_lower for word in ['faculty', 'professor', 'teacher', 'staff', 'instructor']):\n        faculty_members = Faculty.query.all()\n        if faculty_members:\n            context['faculty'] = [{\n                'name': f.name,\n                'designation': f.designation,\n                'department': f.department,\n                'subjects': f.subjects,\n                'email': f.email,\n                'office': f.office\n            } for f in faculty_members]\n    \n    # Check for alumni-related queries\n    if any(word in message_lower for word in ['alumni', 'alumnus', 'graduate', 'passed out']):\n        alumni = Alumni.query.all()\n        if alumni:\n            context['alumni'] = [{\n                'name': a.name,\n                'batch': a.batch,\n                'designation': a.current_designation,\n                'company': a.company\n            } for a in alumni]\n    \n    # Check for bus/transport-related queries\n    if any(word in message_lower for word in ['bus', 'transport', 'route', 'travel']):\n        buses = Bus.query.filter_by(is_active=True).all()\n        if buses:\n            context['buses'] = [{\n                'number': b.bus_number,\n                'route': b.route_description,\n                'stops': [s.stop_name for s in b.stops]\n            } for b in buses]\n        \n        if user.selected_bus:\n            context['my_bus'] = {\n                'number': user.selected_bus.bus_number,\n                'stop': user.selected_stop,\n                'route': user.selected_bus.route_description\n            }\n    \n    # Check for academic resources\n    if any(word in message_lower for word in ['notes', 'resource', 'study', 'material', 'book', 'syllabus', 'pyq']):\n        if user.course and user.branch and user.year:\n            resources = AcademicResource.query.filter_by(\n                course=user.course,\n                branch=user.branch,\n                year=user.year\n            ).limit(10).all()\n            \n            if resources:\n                context['academic_resources'] = [{\n                    'title': r.title,\n                    'subject': r.subject,\n                    'type': r.resource_type,\n                    'views': r.views\n                } for r in resources]\n    \n    # Check for community/posts\n    if any(word in message_lower for word in ['post', 'community', 'announcement', 'news']):\n        posts = CommunityPost.query.order_by(CommunityPost.created_at.desc()).limit(5).all()\n        if posts:\n            context['recent_posts'] = [{\n                'author': p.author.name,\n                'content': p.content[:100] + '...' if len(p.content) > 100 else p.content,\n                'type': p.post_type,\n                'likes': p.likes\n            } for p in posts]\n    \n    return context\n\n\ndef format_context_for_ai(context: dict) -> str:\n    \"\"\"\n    Format database context into a readable string for the AI\n    \"\"\"\n    if not context:\n        return \"\"\n    \n    formatted = \"\\n\\n[Database Information]:\\n\"\n    \n    if 'upcoming_events' in context:\n        formatted += \"\\nUpcoming Events:\\n\"\n        for event in context['upcoming_events']:\n            formatted += f\"- {event['title']}: {event['description']}\\n\"\n            formatted += f\"  Date: {event['date']}, Venue: {event['venue']}\\n\"\n    \n    if 'clubs' in context:\n        formatted += \"\\nCampus Clubs:\\n\"\n        for club in context['clubs']:\n            formatted += f\"- {club['name']}: {club['description']}\\n\"\n            formatted += f\"  Type: {club['type']}, Secretary: {club['secretary']}, Members: {club['members']}\\n\"\n    \n    if 'faculty' in context:\n        formatted += \"\\nFaculty Members:\\n\"\n        for f in context['faculty']:\n            formatted += f\"- {f['name']} ({f['designation']}, {f['department']})\\n\"\n            formatted += f\"  Subjects: {f['subjects']}, Office: {f['office']}\\n\"\n    \n    if 'alumni' in context:\n        formatted += \"\\nNotable Alumni:\\n\"\n        for a in context['alumni']:\n            formatted += f\"- {a['name']} (Batch {a['batch']}): {a['designation']} at {a['company']}\\n\"\n    \n    if 'buses' in context:\n        formatted += \"\\nAvailable Buses:\\n\"\n        for bus in context['buses']:\n            formatted += f\"- Bus {bus['number']}: {bus['route']}\\n\"\n    \n    if 'my_bus' in context:\n        formatted += f\"\\nYour Selected Bus: {context['my_bus']['number']}\\n\"\n        formatted += f\"Your Stop: {context['my_bus']['stop']}\\n\"\n    \n    if 'academic_resources' in context:\n        formatted += \"\\nAvailable Study Materials:\\n\"\n        for r in context['academic_resources']:\n            formatted += f\"- {r['title']} ({r['subject']}) - {r['type']}\\n\"\n    \n    if 'recent_posts' in context:\n        formatted += \"\\nRecent Community Posts:\\n\"\n        for p in context['recent_posts']:\n            formatted += f\"- {p['author']}: {p['content']}\\n\"\n    \n    return formatted\n","size_bytes":6433},"utils/decorators.py":{"content":"from functools import wraps\nfrom flask import request, redirect, url_for, flash\nfrom models import User, Admin, BusManager, Faculty, Alumni\n\ndef login_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        user_id = request.cookies.get('user_id')\n        session_token = request.cookies.get('user_token')\n\n        \n        if not user_id or not session_token:\n            flash('Please login to access this page', 'warning')\n            return redirect(url_for('login'))\n        \n        user = User.query.get(user_id)\n        if not user or user.session_token != session_token:\n            flash('Invalid session. Please login again', 'warning')\n            return redirect(url_for('login'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\ndef admin_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        admin_id = request.cookies.get('admin_id')\n        admin_token = request.cookies.get('admin_token')\n        \n        if not admin_id or not admin_token:\n            flash('Please login as admin', 'warning')\n            return redirect(url_for('admin_login'))\n        \n        admin = Admin.query.get(admin_id)\n        if not admin:\n            flash('Invalid admin session', 'warning')\n            return redirect(url_for('admin_login'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\ndef driver_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        driver_id = request.cookies.get('driver_id')\n        driver_token = request.cookies.get('driver_token')\n        \n        if not driver_id or not driver_token:\n            flash('Please login as driver', 'warning')\n            return redirect(url_for('driver_login'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\ndef bus_manager_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        bus_manager_id = request.cookies.get('bus_manager_id')\n        bus_manager_token = request.cookies.get('bus_manager_token')\n        \n        if not bus_manager_id or not bus_manager_token:\n            flash('Please login as bus manager', 'warning')\n            return redirect(url_for('login'))\n        \n        bus_manager = BusManager.query.get(bus_manager_id)\n        if not bus_manager or bus_manager.session_token != bus_manager_token:\n            flash('Invalid session', 'warning')\n            return redirect(url_for('login'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\ndef faculty_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        faculty_id = request.cookies.get('faculty_id')\n        faculty_token = request.cookies.get('faculty_token')\n        \n        if not faculty_id or not faculty_token:\n            flash('Please login as faculty', 'warning')\n            return redirect(url_for('login'))\n        \n        faculty = Faculty.query.get(faculty_id)\n        if not faculty or faculty.session_token != faculty_token:\n            flash('Invalid session', 'warning')\n            return redirect(url_for('login'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\ndef alumni_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        alumni_id = request.cookies.get('alumni_id')\n        alumni_token = request.cookies.get('alumni_token')\n        \n        if not alumni_id or not alumni_token:\n            flash('Please login as alumni', 'warning')\n            return redirect(url_for('login'))\n        \n        alumni = Alumni.query.get(alumni_id)\n        if not alumni or alumni.session_token != alumni_token:\n            flash('Invalid session', 'warning')\n            return redirect(url_for('login'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\ndef club_leader_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        user_id = request.cookies.get('user_id')\n        session_token = request.cookies.get('session_token')\n        \n        if not user_id or not session_token:\n            flash('Please login to access this page', 'warning')\n            return redirect(url_for('login'))\n        \n        user = User.query.get(user_id)\n        if not user or user.session_token != session_token:\n            flash('Invalid session', 'warning')\n            return redirect(url_for('login'))\n        \n        from models import Club\n        if not Club.query.filter_by(secretary_id=user.id).first():\n            flash('Access denied. Club leader privileges required', 'error')\n            return redirect(url_for('dashboard'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n","size_bytes":4690},"utils/email_utils.py":{"content":"from flask_mail import Message\nfrom flask import url_for\n\ndef send_verification_email(mail, user_email, verification_token, user_name):\n    verification_url = url_for('verify_email', token=verification_token, _external=True)\n    \n    msg = Message(\n        subject='Campus Sphere - Verify Your Email',\n        recipients=[user_email]\n    )\n    \n    msg.html = f'''\n    <html>\n        <body style=\"font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;\">\n            <div style=\"max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px;\">\n                <h2 style=\"color: #667eea;\">Welcome to Campus Sphere!</h2>\n                <p>Hi {user_name},</p>\n                <p>Thank you for registering. Please verify your email address by clicking the button below:</p>\n                <div style=\"text-align: center; margin: 30px 0;\">\n                    <a href=\"{verification_url}\" style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;\">\n                        Verify Email\n                    </a>\n                </div>\n                <p>This link will expire in 15 minutes.</p>\n                <p>If you didn't create an account, please ignore this email.</p>\n                <p>Best regards,<br>Campus Sphere Team</p>\n            </div>\n        </body>\n    </html>\n    '''\n    \n    try:\n        mail.send(msg)\n        return True\n    except Exception as e:\n        print(f\"Error sending email: {e}\")\n        return False\n\ndef send_force_logout_email(mail, email, token, name):\n    logout_link = url_for('force_logout_verify', token=token, _external=True)\n    msg = Message('Force Logout Request', recipients=[email])\n    msg.body = f'''\nHello {name},\n\nYou requested to logout your account from all active devices.\n\nClick the link below to confirm logout (valid for 15 minutes):\n{logout_link}\n\nIf you didn‚Äôt request this, please ignore this email.\n'''\n    mail.send(msg)\n\ndef send_password_reset_email(mail, user_email, reset_token, user_name):\n    reset_url = url_for('reset_password', token=reset_token, _external=True)\n    \n    msg = Message(\n        subject='Campus Sphere - Password Reset Request',\n        recipients=[user_email]\n    )\n    \n    msg.html = f'''\n    <html>\n        <body style=\"font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;\">\n            <div style=\"max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px;\">\n                <h2 style=\"color: #667eea;\">Password Reset Request</h2>\n                <p>Hi {user_name},</p>\n                <p>We received a request to reset your password. Click the button below to create a new password:</p>\n                <div style=\"text-align: center; margin: 30px 0;\">\n                    <a href=\"{reset_url}\" style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;\">\n                        Reset Password\n                    </a>\n                </div>\n                <p>This link will expire in 15 minutes.</p>\n                <p>If you didn't request a password reset, please ignore this email.</p>\n                <p>Best regards,<br>Campus Sphere Team</p>\n            </div>\n        </body>\n    </html>\n    '''\n    \n    try:\n        mail.send(msg)\n        return True\n    except Exception as e:\n        print(f\"Error sending password reset email: {e}\")\n        return False\n","size_bytes":3655},"utils/gemini_utils.py":{"content":"import os\nimport json\nfrom google import genai\nfrom google.genai import types\n\nclient = genai.Client(api_key=\"AIzaSyCEJt7be1KEqyLsOLQHiXmTJF36DaaOKfY\")\n\ndef chat_with_ai(message: str, mode: str = 'normal', user_context: dict = None) -> str:\n    \"\"\"\n    Chat with Gemini AI based on the selected mode\n    \"\"\"\n    try:\n        if mode == 'normal':\n            system_prompt = \"\"\"You are a friendly and helpful virtual teacher assistant for a campus management system. \n            Provide clear, concise answers to student questions.\n            \n            IMPORTANT: If the user's message includes [Database Information], use that real data from the campus database to answer their questions accurately. \n            For example, if they ask about events and you see event data, tell them about those specific events with dates and details.\n            Always prioritize database information over general knowledge when answering campus-specific questions.\"\"\"\n        elif mode == 'practice':\n            system_prompt = \"\"\"You are a practice mode assistant. When asked for practice questions:\n            - Generate coding problems with clear descriptions\n            - Create MCQs with 4 options\n            - Provide subjective questions for deeper understanding\n            - Include test cases for coding problems\n            Do NOT reveal answers until the student submits their solution.\"\"\"\n        elif mode == 'counseling':\n            user_info = \"\"\n            if user_context:\n                user_info = f\"Student Info: {user_context.get('name', 'Student')}, Course: {user_context.get('course', 'N/A')}, Year: {user_context.get('year', 'N/A')}\"\n            system_prompt = f\"\"\"You are a supportive career counselor and mentor for college students. \n            {user_info}\n            Provide personalized guidance, motivation, and career advice. Be empathetic and encouraging.\n            If database information is provided about clubs, faculty, alumni, or resources, use it to give specific recommendations.\"\"\"\n        else:\n            system_prompt = \"You are a helpful virtual teacher assistant.\"\n\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=[\n                types.Content(role=\"user\", parts=[types.Part(text=message)])\n            ],\n            config=types.GenerateContentConfig(\n                system_instruction=system_prompt,\n                temperature=0.7\n            )\n        )\n        \n        return response.text or \"I'm sorry, I couldn't generate a response. Please try again.\"\n    \n    except Exception as e:\n        return f\"Error communicating with AI: {str(e)}\"\n\n\ndef generate_practice_questions(subject: str, question_type: str, difficulty: str = 'medium') -> dict:\n    \"\"\"\n    Generate practice questions using Gemini\n    \"\"\"\n    try:\n        if question_type == 'coding':\n            prompt = f\"\"\"Generate a {difficulty} level coding question for {subject}.\n            Return JSON with: {{\"question\": \"description\", \"test_cases\": [{{\"input\": \"\", \"output\": \"\"}}], \"hints\": []}}\"\"\"\n        elif question_type == 'mcq':\n            prompt = f\"\"\"Generate a {difficulty} level multiple choice question for {subject}.\n            Return JSON with: {{\"question\": \"question text\", \"options\": [\"A\", \"B\", \"C\", \"D\"], \"correct_answer\": \"A\", \"explanation\": \"\"}}\"\"\"\n        else:\n            prompt = f\"\"\"Generate a {difficulty} level subjective question for {subject}.\n            Return JSON with: {{\"question\": \"question text\", \"key_points\": [], \"sample_answer\": \"\"}}\"\"\"\n\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\",\n                temperature=0.8\n            )\n        )\n        \n        if response.text:\n            return json.loads(response.text)\n        return {\"error\": \"Could not generate question\"}\n    \n    except Exception as e:\n        return {\"error\": str(e)}\n\n\ndef check_coding_answer(question: str, user_code: str, test_cases: list) -> dict:\n    \"\"\"\n    Check coding answer using Gemini\n    \"\"\"\n    try:\n        prompt = f\"\"\"Question: {question}\n        \n        User's Code:\n        ```\n        {user_code}\n        ```\n        \n        Test Cases: {json.dumps(test_cases)}\n        \n        Analyze if the code solves the problem correctly. Return JSON with:\n        {{\"correct\": true/false, \"feedback\": \"detailed feedback\", \"passed_tests\": number, \"total_tests\": number}}\"\"\"\n\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            return json.loads(response.text)\n        return {\"error\": \"Could not evaluate answer\"}\n    \n    except Exception as e:\n        return {\"error\": str(e)}\n","size_bytes":5011},"static/css/style.css":{"content":":root {\n    --primary-purple: #7c3aed;\n    --primary-purple-dark: #6d28d9;\n    --primary-purple-light: #a78bfa;\n    --secondary-purple: #8b5cf6;\n    --accent-purple: #c4b5fd;\n    --gradient-primary: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);\n    --gradient-secondary: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\n    --gradient-accent: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);\n    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);\n    --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n    --gradient-dark: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);\n}\n\n@keyframes slide-in {\n    from {\n        transform: translateX(100%);\n        opacity: 0;\n    }\n    to {\n        transform: translateX(0);\n        opacity: 1;\n    }\n}\n\n.animate-slide-in {\n    animation: slide-in 0.3s ease-out;\n}\n\n.glass-card {\n    background: rgba(255, 255, 255, 0.25);\n    backdrop-filter: blur(10px);\n    border: 1px solid rgba(255, 255, 255, 0.18);\n    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);\n}\n\n.gradient-bg-primary {\n    background: var(--gradient-primary);\n}\n\n.gradient-bg-secondary {\n    background: var(--gradient-secondary);\n}\n\n.gradient-bg-accent {\n    background: var(--gradient-accent);\n}\n\n.gradient-bg-success {\n    background: var(--gradient-success);\n}\n\n.gradient-bg-warning {\n    background: var(--gradient-warning);\n}\n\n.sidebar {\n    transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;\n}\n\n.sidebar.collapsed {\n    transform: translateX(-100%);\n}\n\n@media (max-width: 768px) {\n    .sidebar {\n        position: fixed;\n        z-index: 40;\n    }\n}\n\n.btn-primary {\n    background: var(--gradient-primary);\n    color: white;\n    padding: 0.75rem 1.5rem;\n    border-radius: 0.5rem;\n    font-weight: 600;\n    transition: all 0.3s ease;\n    border: none;\n    cursor: pointer;\n}\n\n.btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);\n}\n\n.card-hover {\n    transition: all 0.3s ease;\n}\n\n.card-hover:hover {\n    transform: translateY(-5px);\n    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);\n}\n\n.loader {\n    border: 3px solid #f3f3f3;\n    border-top: 3px solid #667eea;\n    border-radius: 50%;\n    width: 40px;\n    height: 40px;\n    animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n}\n\n.skeleton {\n    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);\n    background-size: 200% 100%;\n    animation: loading 1.5s infinite;\n}\n\n@keyframes loading {\n    0% { background-position: 200% 0; }\n    100% { background-position: -200% 0; }\n}\n\ninput:focus, textarea:focus, select:focus {\n    outline: none;\n    box-shadow: 0 0 0 2px #667eea;\n    border-color: #667eea;\n}\n\n.leaflet-container {\n    height: 100%;\n    border-radius: 0.5rem;\n}\n","size_bytes":2857},"static/js/ai-teacher.js":{"content":"let currentMode = 'normal';\nlet isListening = false;\nlet recognition = null;\nlet synthesis = window.speechSynthesis;\nlet currentTopic = '';\nlet currentQuestionType = '';\nlet currentQuestionData = null;\n\nif ('webkitSpeechRecognition' in window) {\n    recognition = new webkitSpeechRecognition();\n    recognition.continuous = false;\n    recognition.interimResults = false;\n    recognition.lang = 'en-US';\n    \n    recognition.onresult = function(event) {\n        const transcript = event.results[0][0].transcript;\n        document.getElementById('messageInput').value = transcript;\n        sendMessage();\n    };\n    \n    recognition.onend = function() {\n        isListening = false;\n        updateVoiceButton();\n    };\n}\n\n// Auto-start in normal mode on page load\nwindow.addEventListener('DOMContentLoaded', () => {\n    currentMode = 'normal';\n    updateModeUI('normal');\n    addSystemMessage('üëã Welcome! I\\'m your AI teacher. Ask me anything!');\n});\n\nfunction switchMode(mode) {\n    currentMode = mode;\n    \n    // Hide practice flow when switching modes\n    document.getElementById('practiceFlow').style.display = 'none';\n    \n    updateModeUI(mode);\n    \n    const messages = {\n        'normal': 'Switched to Normal Chat Mode',\n        'practice': 'Switched to Practice Mode - Let\\'s start practicing!',\n        'counseling': 'Switched to Counseling Mode'\n    };\n    \n    addSystemMessage(messages[mode]);\n    updateAvatarStatus(`${mode} mode active`);\n    \n    // Show/hide message input based on mode\n    const messageInputContainer = document.querySelector('.flex.gap-2.items-center');\n    \n    // Show practice flow if in practice mode\n    if (mode === 'practice') {\n        document.getElementById('practiceFlow').style.display = 'block';\n        resetPracticeFlow();\n        // Hide message input in practice mode\n        if (messageInputContainer) {\n            messageInputContainer.style.display = 'none';\n        }\n    } else {\n        // Show message input in normal and counseling modes\n        if (messageInputContainer) {\n            messageInputContainer.style.display = 'flex';\n        }\n    }\n}\n\nfunction updateModeUI(mode) {\n    const header = document.getElementById('header');\n    const normalBtn = document.getElementById('normalBtn');\n    const practiceBtn = document.getElementById('practiceBtn');\n    const counselingBtn = document.getElementById('counselingBtn');\n    \n    // Reset all buttons\n    normalBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition';\n    practiceBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition';\n    counselingBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300 transition';\n    \n    if (mode === 'practice') {\n        header.className = 'mode-practice text-white py-6 px-8 transition-all duration-500';\n        practiceBtn.className = 'px-4 py-2 rounded-lg bg-pink-600 text-white text-sm font-medium hover:bg-pink-700 transition';\n    } else if (mode === 'counseling') {\n        header.className = 'mode-counseling text-white py-6 px-8 transition-all duration-500';\n        counselingBtn.className = 'px-4 py-2 rounded-lg bg-cyan-600 text-white text-sm font-medium hover:bg-cyan-700 transition';\n    } else {\n        header.className = 'mode-normal text-white py-6 px-8 transition-all duration-500';\n        normalBtn.className = 'px-4 py-2 rounded-lg bg-purple-600 text-white text-sm font-medium hover:bg-purple-700 transition';\n    }\n}\n\nfunction addSystemMessage(text) {\n    const chatMessages = document.getElementById('chatMessages');\n    \n    if (chatMessages.children[0]?.textContent?.includes('Welcome!')) {\n        chatMessages.innerHTML = '';\n    }\n    \n    const messageDiv = document.createElement('div');\n    messageDiv.className = 'text-center py-2 message-enter';\n    messageDiv.innerHTML = `<span class=\"inline-block bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm\">${text}</span>`;\n    chatMessages.appendChild(messageDiv);\n    chatMessages.scrollTop = chatMessages.scrollHeight;\n}\n\nfunction addMessage(text, isUser = false) {\n    const chatMessages = document.getElementById('chatMessages');\n    \n    if (chatMessages.children[0]?.textContent?.includes('Welcome!')) {\n        chatMessages.innerHTML = '';\n    }\n    \n    const messageDiv = document.createElement('div');\n    messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-enter`;\n    \n    const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });\n    \n    let content = text;\n    let contentClass = 'text-sm message-content';\n    \n    if (!isUser && typeof marked !== 'undefined') {\n        marked.setOptions({\n            breaks: true,\n            gfm: true,\n            highlight: function(code, lang) {\n                if (lang && hljs.getLanguage(lang)) {\n                    return hljs.highlight(code, { language: lang }).value;\n                }\n                return hljs.highlightAuto(code).value;\n            }\n        });\n        \n        content = marked.parse(text);\n        contentClass = 'text-sm ai-response';\n    }\n    \n    messageDiv.innerHTML = `\n        <div class=\"max-w-2xl\">\n            <div class=\"${isUser ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-800'} rounded-2xl px-4 py-3\">\n                <div class=\"${contentClass}\">${content}</div>\n            </div>\n            <p class=\"text-xs text-gray-500 mt-1 ${isUser ? 'text-right' : 'text-left'}\">${time}</p>\n        </div>\n    `;\n    \n    if (!isUser) {\n        addCopyButtonsToCodeBlocks(messageDiv);\n        messageDiv.querySelectorAll('pre code').forEach((block) => {\n            hljs.highlightElement(block);\n        });\n    }\n    \n    chatMessages.appendChild(messageDiv);\n    chatMessages.scrollTop = chatMessages.scrollHeight;\n}\n\nfunction addCopyButtonsToCodeBlocks(container) {\n    const codeBlocks = container.querySelectorAll('pre');\n    codeBlocks.forEach((block) => {\n        const wrapper = document.createElement('div');\n        wrapper.className = 'code-block-wrapper';\n        block.parentNode.insertBefore(wrapper, block);\n        wrapper.appendChild(block);\n        \n        const copyBtn = document.createElement('button');\n        copyBtn.className = 'copy-btn';\n        copyBtn.textContent = 'Copy';\n        copyBtn.onclick = () => {\n            const code = block.textContent;\n            navigator.clipboard.writeText(code).then(() => {\n                copyBtn.textContent = 'Copied!';\n                setTimeout(() => {\n                    copyBtn.textContent = 'Copy';\n                }, 2000);\n            });\n        };\n        wrapper.appendChild(copyBtn);\n    });\n}\n\nfunction showTypingIndicator() {\n    const chatMessages = document.getElementById('chatMessages');\n    const typingDiv = document.createElement('div');\n    typingDiv.id = 'typing-indicator';\n    typingDiv.className = 'flex justify-start message-enter';\n    typingDiv.innerHTML = `\n        <div class=\"bg-gray-100 rounded-2xl typing-indicator\">\n            <span></span>\n            <span></span>\n            <span></span>\n        </div>\n    `;\n    chatMessages.appendChild(typingDiv);\n    chatMessages.scrollTop = chatMessages.scrollHeight;\n}\n\nfunction hideTypingIndicator() {\n    const indicator = document.getElementById('typing-indicator');\n    if (indicator) {\n        indicator.remove();\n    }\n}\n\n// Practice Flow Functions\nfunction resetPracticeFlow() {\n    currentTopic = '';\n    currentQuestionType = '';\n    currentQuestionData = null;\n    \n    // Hide all steps\n    document.querySelectorAll('.practice-step').forEach(step => {\n        step.classList.remove('active');\n    });\n    \n    // Show topic step\n    document.getElementById('topicStep').classList.add('active');\n    document.getElementById('topicInput').value = '';\n}\n\nfunction submitTopic() {\n    const topic = document.getElementById('topicInput').value.trim();\n    if (!topic) {\n        alert('Please enter a topic');\n        return;\n    }\n    \n    currentTopic = topic;\n    \n    // Check if topic is coding related\n    const codingKeywords = ['javascript', 'python', 'java', 'c++', 'coding', 'programming', 'algorithm', 'data structure', 'dsa'];\n    const isCodingTopic = codingKeywords.some(keyword => topic.toLowerCase().includes(keyword));\n    \n    // Show/hide coding option based on topic\n    const codingOption = document.getElementById('codingOption');\n    if (isCodingTopic) {\n        codingOption.style.display = 'block';\n    } else {\n        codingOption.style.display = 'none';\n    }\n    \n    // Move to question type selection\n    document.getElementById('topicStep').classList.remove('active');\n    document.getElementById('questionTypeStep').classList.add('active');\n}\n\nfunction backToTopic() {\n    document.getElementById('questionTypeStep').classList.remove('active');\n    document.getElementById('topicStep').classList.add('active');\n}\n\nasync function selectQuestionType(type) {\n    currentQuestionType = type;\n    \n    // Hide question type step\n    document.getElementById('questionTypeStep').classList.remove('active');\n    \n    // Show loading\n    updateAvatarStatus('Generating question...');\n    showTypingIndicator();\n    \n    try {\n        // Generate question based on type\n        const response = await fetch('/api/chat', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n                message: `Generate a ${type} question about ${currentTopic}. Return only JSON with this structure:\n                For MCQ: {\"type\":\"mcq\",\"question\":\"...\",\"options\":[\"A) ...\",\"B) ...\",\"C) ...\",\"D) ...\"],\"correct\":\"A\",\"explanation\":\"...\"}\n                For subjective: {\"type\":\"subjective\",\"question\":\"...\",\"answer\":\"...\"}\n                For coding: {\"type\":\"coding\",\"question\":\"...\",\"test_cases\":\"...\",\"solution\":\"...\"}`,\n                mode: 'practice'\n            })\n        });\n        \n        const data = await response.json();\n        hideTypingIndicator();\n        \n        if (data.success) {\n            try {\n                // Try to parse JSON from response\n                const jsonMatch = data.response.match(/\\{[\\s\\S]*\\}/);\n                if (jsonMatch) {\n                    currentQuestionData = JSON.parse(jsonMatch[0]);\n                    displayQuestionByType(type);\n                } else {\n                    // Fallback: use response as is\n                    displaySimpleQuestion(type, data.response);\n                }\n            } catch (e) {\n                displaySimpleQuestion(type, data.response);\n            }\n        } else {\n            alert('Error generating question. Please try again.');\n            backToTopic();\n        }\n    } catch (error) {\n        console.error('Error:', error);\n        hideTypingIndicator();\n        alert('Error generating question. Please try again.');\n        backToTopic();\n    }\n}\n\nfunction displayQuestionByType(type) {\n    if (type === 'mcq') {\n        displayMCQ();\n    } else if (type === 'subjective') {\n        displaySubjective();\n    } else if (type === 'coding') {\n        displayCoding();\n    }\n}\n\nfunction displayMCQ() {\n    const mcqQuestion = document.getElementById('mcqQuestion');\n    const mcqOptions = document.getElementById('mcqOptions');\n    \n    mcqQuestion.innerHTML = currentQuestionData.question;\n    \n    let optionsHtml = '';\n    currentQuestionData.options.forEach((option, index) => {\n        const letter = String.fromCharCode(65 + index);\n        optionsHtml += `\n            <label class=\"flex items-center gap-2 p-3 bg-white rounded-lg cursor-pointer hover:bg-blue-50 border border-gray-200\">\n                <input type=\"radio\" name=\"mcqOption\" value=\"${letter}\" class=\"text-blue-600\">\n                <span class=\"text-sm\">${option}</span>\n            </label>\n        `;\n    });\n    mcqOptions.innerHTML = optionsHtml;\n    \n    document.getElementById('mcqDisplay').classList.add('active');\n    document.getElementById('mcqResult').style.display = 'none';\n}\n\nfunction submitMCQ() {\n    const selected = document.querySelector('input[name=\"mcqOption\"]:checked');\n    if (!selected) {\n        alert('Please select an option');\n        return;\n    }\n    \n    const resultDiv = document.getElementById('mcqResult');\n    const isCorrect = selected.value === currentQuestionData.correct;\n    \n    resultDiv.className = 'mt-3 p-3 rounded-lg ' + (isCorrect ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300');\n    \n    let html = '<div class=\"font-semibold ' + (isCorrect ? 'text-green-800' : 'text-red-800') + ' mb-2\">';\n    html += isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect';\n    html += '</div>';\n    html += '<div class=\"text-gray-700\">';\n    html += '<strong>Correct Answer:</strong> ' + currentQuestionData.correct;\n    html += '</div>';\n    \n    if (currentQuestionData.explanation) {\n        html += '<div class=\"text-gray-700 mt-2\"><strong>Explanation:</strong> ' + currentQuestionData.explanation + '</div>';\n    }\n    \n    resultDiv.innerHTML = html;\n    resultDiv.style.display = 'block';\n}\n\nfunction displaySubjective() {\n    const subjectiveQuestion = document.getElementById('subjectiveQuestion');\n    subjectiveQuestion.innerHTML = currentQuestionData.question || 'Question not available';\n    \n    document.getElementById('subjectiveDisplay').classList.add('active');\n    document.getElementById('subjectiveAnswer').style.display = 'none';\n}\n\nfunction showSubjectiveAnswer() {\n    const answerDiv = document.getElementById('subjectiveAnswer');\n    const answer = currentQuestionData.answer || currentQuestionData.explanation || 'Answer not available. Please try generating a new question.';\n    answerDiv.innerHTML = `<div class=\"text-gray-800\">${answer}</div>`;\n    answerDiv.style.display = 'block';\n}\n\nfunction displayCoding() {\n    const codingQuestion = document.getElementById('codingQuestion');\n    const testCases = document.getElementById('testCases');\n    \n    codingQuestion.innerHTML = currentQuestionData.question;\n    testCases.innerHTML = `<strong>Test Cases:</strong><br>${currentQuestionData.test_cases}`;\n    \n    document.getElementById('codingDisplay').classList.add('active');\n    document.getElementById('codeOutput').style.display = 'none';\n    document.getElementById('codeEditor').value = '';\n}\n\nfunction runCode() {\n    const code = document.getElementById('codeEditor').value;\n    const outputDiv = document.getElementById('codeOutput');\n    \n    if (!code.trim()) {\n        alert('Please write some code first');\n        return;\n    }\n    \n    // Simulate code execution (in real app, would send to backend)\n    outputDiv.innerHTML = `\n        <div class=\"text-yellow-400\">‚ö†Ô∏è Code execution simulation</div>\n        <div class=\"text-gray-300 mt-2\">Your code:</div>\n        <pre class=\"text-gray-400 mt-1\">${code}</pre>\n    `;\n    outputDiv.style.display = 'block';\n}\n\nfunction submitCode() {\n    const code = document.getElementById('codeEditor').value;\n    const outputDiv = document.getElementById('codeOutput');\n    \n    if (!code.trim()) {\n        alert('Please write some code first');\n        return;\n    }\n    \n    // Show solution\n    outputDiv.innerHTML = `\n        <div class=\"text-green-400\">‚úÖ Submitted!</div>\n        <div class=\"text-gray-300 mt-3\"><strong>Solution:</strong></div>\n        <pre class=\"text-gray-400 mt-1\">${currentQuestionData.solution || 'Solution not available'}</pre>\n    `;\n    outputDiv.style.display = 'block';\n}\n\nfunction displaySimpleQuestion(type, questionText) {\n    // Fallback for non-JSON responses\n    if (type === 'mcq') {\n        currentQuestionData = {\n            question: questionText,\n            options: ['A) Option A', 'B) Option B', 'C) Option C', 'D) Option D'],\n            correct: 'A',\n            explanation: ''\n        };\n        displayMCQ();\n    } else if (type === 'subjective') {\n        currentQuestionData = {\n            question: questionText,\n            answer: 'Answer will be shown when you click the button.'\n        };\n        displaySubjective();\n    } else if (type === 'coding') {\n        currentQuestionData = {\n            question: questionText,\n            test_cases: 'Test cases not provided',\n            solution: 'Solution not provided'\n        };\n        displayCoding();\n    }\n}\n\nfunction newQuestion() {\n    // Reset all displays\n    document.querySelectorAll('.practice-step').forEach(step => {\n        step.classList.remove('active');\n    });\n    \n    // Go back to topic or question type\n    if (currentTopic) {\n        document.getElementById('questionTypeStep').classList.add('active');\n    } else {\n        document.getElementById('topicStep').classList.add('active');\n    }\n}\n\nasync function sendMessage() {\n    const input = document.getElementById('messageInput');\n    const message = input.value.trim();\n    \n    if (!message) return;\n    \n    addMessage(message, true);\n    input.value = '';\n    \n    updateAvatarStatus('Thinking...');\n    showTypingIndicator();\n    \n    try {\n        const response = await fetch('/api/chat', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n                message: message,\n                mode: currentMode\n            })\n        });\n        \n        const data = await response.json();\n        \n        hideTypingIndicator();\n        \n        if (data.success) {\n            addMessage(data.response, false);\n            updateAvatarStatus('Ready to help!');\n            \n            if (document.getElementById('soundToggle').checked) {\n                const plainText = data.response.replace(/[#*`\\[\\]]/g, '');\n                speak(plainText);\n            }\n        } else {\n            addMessage('Sorry, I encountered an error. Please try again.', false);\n            updateAvatarStatus('Error occurred');\n        }\n    } catch (error) {\n        console.error('Error:', error);\n        hideTypingIndicator();\n        addMessage('Sorry, I could not connect. Please try again.', false);\n        updateAvatarStatus('Connection error');\n    }\n}\n\nfunction toggleVoice() {\n    if (!recognition) {\n        alert('Voice recognition is not supported in your browser.');\n        return;\n    }\n    \n    if (isListening) {\n        recognition.stop();\n        isListening = false;\n    } else {\n        recognition.start();\n        isListening = true;\n        updateAvatarStatus('Listening...');\n    }\n    \n    updateVoiceButton();\n}\n\nfunction updateVoiceButton() {\n    const btn = document.getElementById('voiceBtn');\n    if (isListening) {\n        btn.innerHTML = 'üî¥';\n        btn.classList.add('pulse-ring');\n    } else {\n        btn.innerHTML = 'üé§';\n        btn.classList.remove('pulse-ring');\n    }\n}\n\nfunction speak(text) {\n    if (synthesis.speaking) {\n        synthesis.cancel();\n    }\n    \n    const utterance = new SpeechSynthesisUtterance(text);\n    utterance.rate = 1.0;\n    utterance.pitch = 1.0;\n    utterance.volume = 1.0;\n    \n    synthesis.speak(utterance);\n}\n\nfunction updateAvatarStatus(status) {\n    document.getElementById('avatarStatus').textContent = status;\n}\n","size_bytes":19268},"static/js/auth.js":{"content":"function hideWarning() {\n    document.getElementById('device-warning').classList.add('hidden');\n}\n\nfunction forceLogout() {\n    const form = document.querySelector('form');\n    const input = document.createElement('input');\n    input.type = 'hidden';\n    input.name = 'force_logout';\n    input.value = 'true';\n    form.appendChild(input);\n    form.submit();\n}\n","size_bytes":360},"static/js/bus-tracking.js":{"content":"let map = null;\nlet busMarker = null;\nlet stopMarkers = [];\nlet currentBusId = null;\n\ndocument.addEventListener('DOMContentLoaded', function() {\n    map = L.map('busMap').setView([28.6139, 77.2090], 13);\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: '¬© OpenStreetMap contributors'\n    }).addTo(map);\n    \n    const busSelect = document.getElementById('bus-select');\n    if (busSelect && busSelect.value) {\n        loadBusData(busSelect.value);\n    }\n});\n\nfunction selectBus() {\n    const busId = document.getElementById('bus-select').value;\n    if (!busId) {\n        alert('Please select a bus');\n        return;\n    }\n    \n    fetch('/select-bus', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ bus_id: busId })\n    })\n    .then(response => response.json())\n    .then(data => {\n        alert(data.message);\n        loadBusData(busId);\n    });\n}\n\nfunction loadBusData(busId) {\n    currentBusId = busId;\n    \n    fetch(`/bus/${busId}/data`)\n        .then(response => response.json())\n        .then(data => {\n            updateMap(data);\n            document.getElementById('bus-info').classList.remove('hidden');\n            document.getElementById('stops-list').classList.remove('hidden');\n        });\n    \n    setInterval(() => {\n        if (currentBusId) {\n            fetch(`/bus/${currentBusId}/location`)\n                .then(response => response.json())\n                .then(data => updateBusLocation(data));\n        }\n    }, 5000);\n}\n\nfunction updateMap(data) {\n    if (data.current_lat && data.current_lng) {\n        if (busMarker) {\n            busMarker.setLatLng([data.current_lat, data.current_lng]);\n        } else {\n            busMarker = L.marker([data.current_lat, data.current_lng]).addTo(map);\n        }\n        map.setView([data.current_lat, data.current_lng], 14);\n    }\n    \n    stopMarkers.forEach(marker => marker.remove());\n    stopMarkers = [];\n    \n    if (data.stops) {\n        let stopsHTML = '';\n        data.stops.forEach(stop => {\n            const color = stop.is_crossed ? '#ef4444' : '#10b981';\n            const marker = L.circleMarker([stop.lat, stop.lng], {\n                color: color,\n                fillColor: color,\n                fillOpacity: 0.5,\n                radius: 8\n            }).addTo(map).bindPopup(stop.stop_name);\n            stopMarkers.push(marker);\n            \n            stopsHTML += `\n                <div class=\"flex items-center justify-between p-2 rounded\" style=\"background-color: ${stop.is_crossed ? '#fee2e2' : '#d1fae5'}\">\n                    <span class=\"text-sm\">${stop.stop_name}</span>\n                    <span class=\"text-xs ${stop.is_crossed ? 'text-red-600' : 'text-green-600'}\">${stop.is_crossed ? 'Crossed' : 'Upcoming'}</span>\n                </div>\n            `;\n        });\n        document.getElementById('stops-container').innerHTML = stopsHTML;\n    }\n}\n\nfunction updateBusLocation(data) {\n    if (data.lat && data.lng && busMarker) {\n        busMarker.setLatLng([data.lat, data.lng]);\n    }\n}\n","size_bytes":3100},"static/js/dashboard.js":{"content":"const sidebarToggle = document.getElementById('sidebar-toggle');\nconst sidebar = document.getElementById('sidebar');\nconst profileDropdownBtn = document.getElementById('profile-dropdown-btn');\nconst profileDropdown = document.getElementById('profile-dropdown');\n\nif (sidebarToggle) {\n    sidebarToggle.addEventListener('click', () => {\n        sidebar.classList.toggle('collapsed');\n    });\n}\n\nif (profileDropdownBtn) {\n    profileDropdownBtn.addEventListener('click', () => {\n        profileDropdown.classList.toggle('hidden');\n    });\n    \n    document.addEventListener('click', (e) => {\n        if (!profileDropdownBtn.contains(e.target) && !profileDropdown.contains(e.target)) {\n            profileDropdown.classList.add('hidden');\n        }\n    });\n}\n","size_bytes":756},"static/js/main.js":{"content":"setTimeout(() => {\n    const flashMessages = document.querySelectorAll('.flash-message');\n    flashMessages.forEach(msg => {\n        msg.style.opacity = '0';\n        setTimeout(() => msg.remove(), 300);\n    });\n}, 5000);\n","size_bytes":221}},"version":1}